# Rustæ€§èƒ½è¯„ä¼°ä¸è°ƒä¼˜å®è·µ

ä½œè€…ï¼šå¼ æ±‰ä¸œ

---

## å†…å®¹ä»‹ç»

- Rust æ€§èƒ½ä¼˜åŒ–æ€»åˆ™
- Rust æ€§èƒ½ä¼˜åŒ–å‡†å¤‡å·¥ä½œ
- Rust æ€§èƒ½å‰–æå·¥å…·ä»‹ç»
- æ—¥å¸¸ Rust å¼€å‘æ€§èƒ½ä¼˜åŒ–çš„æŠ€å·§æ€»ç»“
- Rust ç¼–è¯‘å¤§å°å’Œç¼–è¯‘æ—¶é—´ä¼˜åŒ–æŠ€å·§

æœ¬æ¬¡åˆ†äº«å°†å›´ç»• Rust æ€§èƒ½è¯„ä¼°å’Œè°ƒä¼˜ä¸»é¢˜ï¼Œæ¯”è¾ƒç³»ç»Ÿåœ°ä»‹ç» Rust ä»£ç çš„æ€§èƒ½ä¼˜åŒ–ç»éªŒã€‚å…ˆä»å¤§çš„æ€»åŸåˆ™å‡ºå‘ï¼Œä»‹ç»åœ¨ç¼–å†™ Rust è¿‡ç¨‹ä¸­åº”è¯¥éµå¾ªå“ªäº›åŸåˆ™å¯¹åç»­ä¼˜åŒ–æœ‰å¸®åŠ©ã€‚æ¥ä¸‹æ¥ä¼šåˆ†äº«ä¸€äº›ä»£ç ä¼˜åŒ–çš„æ–¹æ³•å’ŒæŠ€å·§ï¼Œç„¶åä»‹ç»å¯ä»¥ç”¨äº Rust ä»£ç æ€§èƒ½è¯„ä¼°çš„å·¥å…·ï¼Œä¹Ÿä¼šåŒ…æ‹¬ Rustä¸“ç”¨çš„ä¸€äº›å¼‚æ­¥å¹¶å‘æµ‹è¯•å·¥å…·ä»‹ç»ã€‚

## å¼•å­

Rust è¯­è¨€å¤©ç”Ÿä¸ºå¹¶å‘å’Œå®‰å…¨è€Œè®¾è®¡ï¼Œå¹¶ä¸”å€Ÿé‰´äº†é¢å‘è¿‡ç¨‹/é¢å‘å¯¹è±¡/å‡½æ•°å¼ç­‰è¯­è¨€çš„ç‰¹ç‚¹ã€‚Rust çš„ç›®æ ‡åœ¨æ€§èƒ½æ–¹é¢å¯¹æ ‡ C è¯­è¨€ï¼Œä½†åœ¨å®‰å…¨å’Œç”Ÿäº§åŠ›æ–¹é¢åˆ™æ¯” C æ›´èƒœä¸€ç­¹ã€‚

è™½è¯´ Rust è¯­è¨€æ€§èƒ½å¯¹æ ‡ C è¯­è¨€ï¼Œä½†å¼€å‘è€…å†™å‡ºçš„Rust ä»£ç å¦‚æœä¸ç»ä»»ä½•ä¼˜åŒ–ï¼Œä¹Ÿæœ‰å¯èƒ½æ¯” Python æ›´æ…¢ã€‚å¯¼è‡´ Rust ä»£ç æ€§èƒ½æ…¢çš„å› ç´ æœ‰å¾ˆå¤šç§ï¼Œæœ¬æ–‡å°±æ˜¯å°è¯•æ¥æ¢³ç†è¿™äº›æƒ…å†µï¼Œå¹¶ä¸”ç»™å‡ºä¸€å¥—æ–¹æ³•è®ºå’Œä¸€äº›å·¥å…·é›†ï¼Œæ¥å¸®åŠ©å¼€å‘è€…ç¼–å†™é«˜æ€§èƒ½çš„ Rust ä»£ç ã€‚

## Rust æ€§èƒ½ä¼˜åŒ–æ€»åˆ™

### åŸåˆ™ä¸€ï¼š ä¸è¦è¿‡æ—©ä¼˜åŒ–æ€§èƒ½

> è¿‡æ—©ä¼˜åŒ–ï¼ˆPremature Optimizationï¼‰
>
> Premature optimization is the root of all evil. -- DonaldKnuth
>
> åœ¨ DonaldKnuth çš„è®ºæ–‡ ã€Š Structured Programming With GoTo Statements ã€‹ä¸­ï¼Œä»–å†™é“ï¼š"ç¨‹åºå‘˜æµªè´¹äº†å¤§é‡çš„æ—¶é—´å»è€ƒè™‘æˆ–æ‹…å¿ƒç¨‹åºä¸­éå…³é”®éƒ¨åˆ†çš„é€Ÿåº¦ï¼Œè€Œå½“è€ƒè™‘åˆ°è°ƒè¯•å’Œç»´æŠ¤æ—¶ï¼Œè¿™äº›å¯¹æ•ˆç‡çš„å°è¯•å®é™…ä¸Šä¼šäº§ç”Ÿå¼ºçƒˆçš„è´Ÿé¢å½±å“ã€‚æˆ‘ä»¬åº”è¯¥å¿˜è®°è¿™ç§å¾®å°çš„æ•ˆç‡ï¼Œæ¯”å¦‚è¯´å› ä¸ºè¿‡æ—©ä¼˜åŒ–è€Œæµªè´¹çš„å¤§çº¦97%çš„æ—¶é—´ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¸åº”è¯¥æ”¾å¼ƒé‚£å…³é”®çš„ 3% çš„æœºä¼š"ã€‚

æƒ³æŠŠä»£ç ä¼˜åŒ–åˆ°æœ€ä½³ï¼Œéœ€è¦èŠ±å¾ˆå¤šç²¾åŠ›ã€‚ä¸åº”è¯¥åœ¨å¼€å‘çš„æ—¶å€™å»æƒ³ç€ä¼˜åŒ–çš„äº‹æƒ…ï¼Œä¸éœ€è¦ä¸€æ­¥åˆ°ä½ã€‚å…ˆå®Œæˆå†å®Œç¾ã€‚

ä½†æ˜¯å¹¶éæ‰€æœ‰ä¼˜åŒ–è¿‡æ—©ã€‚åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œä¼˜åŒ–ä»£ç çš„å¯è¯»æ€§æ˜¯ä½ æŒç»­è¦åšçš„ã€‚Rust æ˜¯ä¸€é—¨è®²ç©¶æ˜¾å¼è¯­ä¹‰çš„è¯­è¨€ï¼Œåœ¨å‘½åä¸Šä½“ç°å‡ºç±»å‹çš„è¯­ä¹‰ï¼Œå¯¹äºæå‡å¯è¯»æ€§éå¸¸é‡è¦ã€‚

### åŸåˆ™äºŒï¼š ä¸è¦è¿‡åº¦ä¼˜åŒ–æ€§èƒ½

RustConf 2021 ä¸€ä¸ªæ¼”è®²å°±ä¸¾äº†ä¸€ä¸ªè¿‡åº¦ä¼˜åŒ–ä¾‹å­ï¼š

æŸä¸ªç”¨æˆ·åªæ˜¯æƒ³å†™ä¸€äº›æ¯” Python ç¨‹åºæ€§èƒ½æ›´å¥½çš„ä»£ç ã€‚ç¬¬ä¸€ç‰ˆ Rust å®ç°çš„ä»£ç å·²ç»è¾¾åˆ°äº†è¿™ä¸ªè¦æ±‚ï¼Œæ¯” Python ä»£ç å¿« 20å€ã€‚ä½†æ˜¯ä»–ä»¬èŠ±äº†ä¹ç‰›äºŒè™ä¹‹åŠ›å†™çš„ç¬¬äºŒä¸ª Rust ç‰ˆæœ¬ï¼Œå’Œç¬¬ä¸€ä¸ªç‰ˆæœ¬å·®è·å¹¶ä¸å¤§ã€‚

![1](./image/perf/1.png)

æ€§èƒ½å¤Ÿç”¨å°±å¥½ï¼Œå¦åˆ™å°±å®¹æ˜“æµªè´¹ä¸å¿…è¦çš„æ—¶é—´ã€‚

### åŸåˆ™ä¸‰ï¼š Rust ä»£ç çš„æ€§èƒ½ã€å®‰å…¨ã€ç¼–è¯‘é€Ÿåº¦å’Œç¼–è¯‘å¤§å°ä¹‹é—´éœ€è¦æƒè¡¡

Rust æ˜¯åŒæ—¶æ³¨é‡å®‰å…¨å’Œæ€§èƒ½çš„è¯­è¨€ã€‚ä½†æ˜¯åœ¨ä¼˜åŒ–æ€§èƒ½çš„åŒæ—¶ï¼Œæ˜¯æœ‰å¯èƒ½æŸå¤±å®‰å…¨æ€§çš„ã€‚æ¯”å¦‚ä½¿ç”¨ Unsafe Rust æ¥æå‡æ€§èƒ½ï¼Œè€Œå¿½ç•¥å®‰å…¨æ£€æŸ¥åœ¨æŸäº›è°ƒç”¨ç¯å¢ƒæ¯”è¾ƒå®‰å…¨çš„åœ°æ–¹æ˜¯å…è®¸çš„ï¼Œä½†æ˜¯å¹¶éé€šç”¨çš„åšæ³•ã€‚æ‰€ä»¥åœ¨ä¼˜åŒ–æ€§èƒ½ä¹‹å‰ï¼Œè¦è€ƒè™‘æ˜¯å¦è¦ç‰ºç‰²å®‰å…¨æ€§ã€‚

å¦å¤– Rust ä¼˜åŒ–æ€§èƒ½çš„åŒæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¼–è¯‘é€Ÿåº¦å˜æ…¢ å’Œ ç¼–è¯‘æ–‡ä»¶å¤§å°è†¨èƒ€ã€‚è¿™ä¹Ÿæ˜¯éœ€è¦æƒè¡¡çš„åœ°æ–¹ã€‚

## Rust ä¼˜åŒ–å‡†å¤‡å·¥ä½œ

åœ¨æ€§èƒ½ä¼˜åŒ–ä¹‹å‰ï¼Œä½ è¿˜éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œç”¨äºæµ‹é‡ä½ çš„ä¼˜åŒ–æ˜¯å¦æœ‰æ•ˆã€‚

####  åŸºå‡†æµ‹è¯•

ç¬¬ä¸€æ­¥æ˜¯å»ºç«‹ä¸€å¥—ä¸€è‡´çš„åŸºå‡†ï¼Œå¯ä»¥ç”¨æ¥ç¡®å®šæ€§èƒ½çš„åŸºçº¿æ°´å¹³ï¼Œå¹¶è¡¡é‡ä»»ä½•æ¸è¿›çš„æ”¹è¿›ã€‚

>  å‚è€ƒï¼š
>
>  `mongodb` çš„æ¡ˆä¾‹ä¸­ï¼Œæ ‡å‡†åŒ–çš„[`MongoDB` é©±åŠ¨å¾®åŸºå‡†é›†](https://github.com/mongodb/specifications/blob/master/source/benchmarking/benchmarking.rst)åœ¨è¿™æ–¹é¢å‘æŒ¥äº†å¾ˆå¥½çš„ä½œç”¨ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºå®ƒå…è®¸åœ¨ç”¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„`MongoDB`é©±åŠ¨ä¹‹é—´è¿›è¡Œæ¯”è¾ƒã€‚ç”±äºè¿™äº›æ˜¯ "å¾® "åŸºå‡†ï¼Œå®ƒä»¬è¿˜å¯ä»¥å¾ˆå®¹æ˜“åœ°æµ‹é‡å•ä¸ªç»„ä»¶çš„å˜åŒ–ï¼ˆä¾‹å¦‚ï¼Œè¯»ä¸å†™ï¼‰ï¼Œè¿™åœ¨ä¸“æ³¨äºåœ¨ç‰¹å®šé¢†åŸŸè¿›è¡Œæ”¹è¿›æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚

ä¸€æ—¦é€‰æ‹©äº†åŸºå‡†ï¼Œå°±åº”è¯¥å»ºç«‹ä¸€ä¸ªç¨³å®šçš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œæ‰€æœ‰çš„å®šæ—¶æµ‹é‡ã€‚ç¡®ä¿ç¯å¢ƒä¸å‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”åœ¨åˆ†ææ—¶ä¸åšå…¶ä»– "å·¥ä½œ"ï¼ˆå¦‚æµè§ˆçŒ«çš„å›¾ç‰‡ï¼‰ï¼Œè¿™å¯¹å‡å°‘åŸºå‡†æµ‹é‡ä¸­çš„å™ªéŸ³å¾ˆé‡è¦ã€‚

æ¨èå·¥å…·ï¼š

ä½¿ç”¨ cargo bench å’Œ [`criterion`](https://crates.io/crates/criterion)  æ¥è¿›è¡ŒåŸºå‡†æµ‹è¯•

```toml
[dev-dependencies]
criterion = { version = "0.3.5", features = ["async_tokio", "html_reports"] }

[[bench]]
name = "find"
harness = false
```

å› ä¸º Rust è‡ªå¸¦çš„åŸºå‡†æµ‹è¯•åªèƒ½ç”¨äºNightly Rust ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ criterion åœ¨ Stable Rust ä¸‹è¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚

Criterion ä¼šå°†æ¯æ¬¡è¿è¡Œçš„æ—¶é—´è®°å½•ã€åˆ†æåˆ°ä¸€ä¸ª HTML æŠ¥å‘Šä¸­ã€‚

![2](./image/perf/2.png)

åœ¨æŠ¥å‘Šçš„åº•éƒ¨ï¼Œæœ‰ä¸¤ä¸ªæœ€è¿‘çš„è¿è¡Œä¹‹é—´çš„æ¯”è¾ƒï¼Œè¾ƒæ—©çš„è¿è¡Œï¼ˆåŸºçº¿ï¼‰ä¸ºçº¢è‰²ï¼Œæœ€è¿‘çš„è¿è¡Œï¼ˆä¼˜åŒ–çš„ï¼‰ä¸ºè“è‰²ã€‚è¿™äº›æŠ¥å‘Šæ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œç”¨äºå¯è§†åŒ–ç”±äºæ€§èƒ½è°ƒæ•´è€Œå‘ç”Ÿçš„å˜åŒ–ï¼Œå¹¶ä¸”å®ƒä»¬å¯¹äºå‘å…¶ä»–äººå±•ç¤ºç»“æœç‰¹åˆ«æœ‰ç”¨ã€‚

å®ƒä»¬è¿˜å¯ä»¥ä½œä¸ºè¿‡å»æ€§èƒ½æ•°æ®çš„è®°å½•ï¼Œæ— éœ€æ‰‹åŠ¨è®°å½•ç»“æœã€‚å¦‚æœæœ‰æ€§èƒ½å›å½’çš„æƒ…å†µï¼Œä¹Ÿä¼šå¾—åˆ°åŠæ—¶çš„åæ˜ ã€‚

#### å‹åŠ›/è´Ÿè½½æµ‹è¯•

åŸºå‡†æµ‹è¯•æ˜¯å¼€å‘è¿‡ç¨‹ä¸­å¯¹ç¨‹åºæ€§èƒ½çš„ä¸€ç§é¢„åˆ¤ã€‚è€Œé¡¹ç›®æœ€ç»ˆå‘å¸ƒä¹‹åï¼Œè¿˜éœ€è¦åœ¨å®é™…ç¯å¢ƒå¯¹å…¶è¿›è¡ŒçœŸæ­£çš„è´Ÿè½½æµ‹è¯•ï¼Œæ¥åˆ¤æ–­ç³»ç»Ÿçš„å»¶æ—¶å’Œååé‡ã€‚

å¸¸ç”¨çš„è´Ÿè½½æµ‹è¯•å·¥å…·åŸºæœ¬éƒ½å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚ locustï¼Œwrkä¹‹ç±»ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸ª Rust åŸºé‡‘ä¼šæˆå‘˜å…¬å¸çš„ä¸€ä¸ªç”¨ Rust å®ç°çš„å¼€æºåˆ†å¸ƒå¼è´Ÿè½½æµ‹è¯•å·¥å…· ï¼š[goose](https://github.com/tag1consulting/goose)ã€‚

Goose æ¯ CPU æ ¸äº§ç”Ÿçš„æµé‡è‡³å°‘æ˜¯ Locust çš„ 11 å€ï¼Œå¯¹äºæ›´å¤æ‚çš„è´Ÿè½½æµ‹è¯•ï¼ˆä¾‹å¦‚ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æŠ“å–è¡¨å•å†…å®¹çš„è´Ÿè½½æµ‹è¯•ï¼‰ï¼Œæ”¶ç›Šç”šè‡³æ›´å¤§ã€‚è™½ç„¶ Locust è¦æ±‚æ‚¨ç®¡ç†åˆ†å¸ƒå¼è´Ÿè½½æµ‹è¯•ï¼Œåªæ˜¯ä¸ºäº†åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šä½¿ç”¨å¤šä¸ª CPU å†…æ ¸ï¼Œä½† Goose ä½¿ç”¨å•ä¸ªè¿›ç¨‹åˆ©ç”¨æ‰€æœ‰å¯ç”¨çš„ CPU å†…æ ¸ï¼Œä»è€Œå¤§å¤§ç®€åŒ–äº†è¿è¡Œæ›´å¤§è´Ÿè½½æµ‹è¯•çš„è¿‡ç¨‹ã€‚å¯¹ä»£ç åº“çš„æŒç»­æ”¹è¿›ç»§ç»­å¸¦æ¥æ–°åŠŸèƒ½å’Œæ›´å¿«çš„æ€§èƒ½ã€‚Goose çš„æ‰©å±•æ€§è¿œè¿œä¼˜äº Locustï¼Œå¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨å¯ç”¨èµ„æºæ¥å®ç°å…¶ç›®æ ‡ã€‚å®ƒè¿˜æ”¯æŒå¼‚æ­¥æµç¨‹ï¼Œä½¿æ›´å¤šçš„åŒæ­¥æµç¨‹èƒ½å¤Ÿè½»æ¾ä¸”ä¸€è‡´åœ°ä»å•ä¸ªæœåŠ¡å™¨ä¸Šå¢åŠ æ•°åƒåç”¨æˆ·ã€‚

Goose æ‹¥æœ‰è®¸å¤šå…¶ä»–è´Ÿè½½æµ‹è¯•å·¥å…·æ‰€æ²¡æœ‰çš„ç‹¬ç‰¹[è°ƒè¯•å’Œæ—¥å¿—è®°å½•æœºåˆ¶](https://book.goose.rs/logging/overview.html)ï¼Œç®€åŒ–äº†è´Ÿè½½æµ‹è¯•çš„ç¼–å†™å’Œç»“æœçš„åˆ†æã€‚Goose è¿˜é€šè¿‡å¯¹æ•°æ®çš„å¤šä¸ªç®€å•è§†å›¾æä¾›äº†æ›´[å…¨é¢çš„æŒ‡æ ‡](https://book.goose.rs/getting-started/metrics.html)ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°ç¡®è®¤è´Ÿè½½æµ‹è¯•åœ¨æ‚¨æŒ‰æ¯”ä¾‹æ”¾å¤§æˆ–ç¼©å°æ—¶æŒ‰ç…§æ‚¨çš„é¢„æœŸæ‰§è¡Œã€‚å®ƒå…¬å¼€äº†ç”¨äºåˆ†é…ä»»åŠ¡å’Œä»»åŠ¡é›†çš„ç®—æ³•ï¼Œå¯¹æ“ä½œçš„é¡ºåºå’Œä¸€è‡´æ€§è¿›è¡Œ[æ›´ç²¾ç»†çš„æ§åˆ¶](https://book.goose.rs/config/scheduler.html)ï¼Œè¿™å¯¹äºæ˜“äºé‡å¤çš„æµ‹è¯•å¾ˆé‡è¦ã€‚

![3](./image/perf/3.png)



####  æ˜ç™½é«˜æ€§èƒ½ç³»ç»Ÿçš„æ ‡å‡†

åœ¨è¿›è¡Œæ€§èƒ½å‰–æä¹‹å‰ï¼Œè¿˜åº”è¯¥æ˜ç™½é«˜æ€§èƒ½ç³»ç»Ÿçš„ä¸€ä¸ªæ ‡å‡†ã€‚

æ€§èƒ½ = äº§å‡º / èµ„æºæ¶ˆè€—

äº§å‡º = äº‹åŠ¡æ¬¡æ•°ï¼ˆæ¯”å¦‚ï¼Œqpsï¼‰å’Œ ååçš„æ•°æ®é‡

æ¶ˆè€—èµ„æº = cpuæ—¶é—´ç‰‡ï¼Œç£ç›˜/ç½‘ç»œ I/O æ¬¡æ•°ã€æµé‡ ç­‰

è€Œé«˜æ€§èƒ½çš„ç³»ç»Ÿæ˜¯è¦æ±‚åœ¨å›ºå®šèµ„æºæ¶ˆè€—ä¹‹ä¸‹æ¥æé«˜äº§å‡ºã€‚

å¯¹äºé«˜æ€§èƒ½ç³»ç»Ÿçš„è®¾è®¡ä¸€èˆ¬éµå¾ªä¸¤ä¸ªæ ‡å‡†ï¼š

1. æœ€å¤§åŒ–åœ°åˆ©ç”¨èµ„æºã€‚
2. ä½¿ç”¨æµæ°´çº¿æŠ€æœ¯å‡å°‘ç¨‹åºä¸­ä»»åŠ¡æ€»è€—æ—¶ã€‚æ¯”å¦‚ Rust ç¼–è¯‘å™¨ä¼˜åŒ–ç¼–è¯‘æ—¶é—´ï¼Œä¹Ÿä½¿ç”¨äº†æµæ°´çº¿æŠ€æœ¯æ¥å¯¹crateè¿›è¡Œå¹¶è¡Œç¼–è¯‘ã€‚

å¸¸è§ç“¶é¢ˆç±»å‹ï¼š

1. CPU :  
   1. CPU å ç”¨è¿‡é«˜ï¼Œé‚£ä¹ˆå°±éœ€è¦å‡å°‘è®¡ç®—çš„å¼€é”€ã€‚
   2. CPU è´Ÿè½½è¿‡é«˜ï¼Œé‚£ä¹ˆå°±éœ€è¦æŸ¥çœ‹æ˜¯å¦çº¿ç¨‹è¿‡å¤šï¼Œä»¥åŠå¤šä¸ªçº¿ç¨‹çš„åˆ‡æ¢å¤ªè¿‡é¢‘ç¹ï¼Œå¤šçº¿ç¨‹äº¤äº’æ˜¯å¦æœ‰å¿…è¦ã€‚
2. I/O:
   1. ç£ç›˜ IOPS(Input/Output Operations Per Second) è¾¾åˆ°äº†ä¸Šé™ã€‚é‚£ä¹ˆéœ€è¦å‡å°‘è¯»å†™æ¬¡æ•°ï¼Œæé«˜ cacheå‘½ä¸­ç‡ã€‚
   2. IO å¸¦å®½ï¼ˆbandwidthï¼‰ ä¸Šé™ã€‚é‚£ä¹ˆå°±éœ€è¦å‡å°‘ç£ç›˜çš„è¯»å†™æµé‡ï¼Œæ¯”å¦‚ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œæ›´å°çš„è¯»å†™æ”¾å¤§ï¼ˆæœ¬æ¥åªéœ€è¦è¯»å–100å­—èŠ‚ï¼Œç»“æœè§¦å‘äº†å¥½å¤šä¸ªpageçš„è¯»å†™ï¼Œäº§ç”Ÿäº†æ”¾å¤§çš„æ•ˆæœï¼‰ã€‚
   3. I/O å¹¶å‘è¾¾åˆ°ä¸Šé™ã€‚é‚£ä¹ˆå°±éœ€è¦è€ƒè™‘ä½¿ç”¨ å¼‚æ­¥I/Oã€‚
   4. é”ã€è®¡æ—¶å™¨ã€åˆ†é¡µ/äº¤æ¢ç­‰è¢«é˜»å¡ã€‚

## Rust æ€§èƒ½å‰–æå·¥å…·ä»‹ç»

åœ¨åšå¥½å‡†å¤‡å·¥ä½œä¹‹åï¼Œå°±å¯ä»¥å¼€å¯æˆ‘ä»¬çš„æ€§èƒ½å‰–æå·¥ä½œäº†ã€‚

æ€§èƒ½å‰–æï¼Œå°±æ˜¯è¦å‘ç°ç¨‹åºä¸­çœŸæ­£å­˜åœ¨çš„æ€§èƒ½ç“¶é¢ˆã€‚è€Œä¸æ˜¯ä½ è‡ªä»¥ä¸ºçš„æƒ³è±¡ä¸­çš„æ€§èƒ½ç“¶é¢ˆã€‚å¦‚æœä¸éµå®ˆè¿™ç‚¹ï¼Œå°±ä¼šå¯¼è‡´è¿‡æ—©ä¼˜åŒ–æˆ–è¿‡åº¦ä¼˜åŒ–ã€‚

å› ä¸ºå¸¸è§çš„æ€§èƒ½ç“¶é¢ˆä¸€èˆ¬éƒ½æ˜¯ä¸¤ç±»ï¼ŒCPU å’Œ I/O ã€‚æ‰€ä»¥å·¥å…·ä¹ŸåŸºæœ¬é¢å‘è¿™ä¸¤ç±»ã€‚

### On-CPU æ€§èƒ½å‰–æ

#### ä½¿ç”¨ Perf å¯»æ‰¾â€œçƒ­ç‚¹â€

åšcpuæ€§èƒ½å‰–ææœ‰å¾ˆå¤šå¸¸ç”¨çš„ Linux å‘½ä»¤è¡Œå·¥å…·ï¼Œæ¯”å¦‚ linux å‘½ä»¤è¡Œå·¥å…· perfã€‚å®ƒåŠŸèƒ½å¼ºå¤§ï¼šå®ƒå¯ä»¥æ£€æµ‹ CPU æ€§èƒ½è®¡æ•°å™¨ã€è·Ÿè¸ªç‚¹ã€kprobes å’Œ uprobesï¼ˆåŠ¨æ€è·Ÿè¸ªï¼‰ã€‚

ä½ å¯ä»¥ä½¿ç”¨ perf å·¥å…·å¯¹ CPU è¿›è¡Œé‡‡æ ·åˆ†æã€‚ä»¥ä¸€ä¸ªæŒ‡å®šçš„é¢‘ç‡å¯¹CPUè¿›è¡Œé‡‡æ ·ï¼Œè¿›è€Œæ‹¿åˆ°æ­£åœ¨CPUä¸Šè¿è¡Œçš„æŒ‡ä»¤ä¹ƒè‡³æ•´ä¸ªå‡½æ•°è°ƒç”¨æ ˆçš„å¿«ç…§ï¼Œæœ€åå¯¹é‡‡æ ·çš„æ•°æ®åˆ†æã€‚æ¯”å¦‚è¯´åœ¨100æ¬¡é‡‡æ ·ä¸­æœ‰20æ¬¡åœ¨è¿è¡ŒAæŒ‡ä»¤æˆ–è€…Aå‡½æ•°ï¼Œé‚£ä¹ˆ`perf`å°±ä¼šè®¤ä¸ºAå‡½æ•°çš„CPUä½¿ç”¨ç‡ä¸º20%ã€‚

å¯ä»¥åœ¨ Cargo.toml  ä¸­åŠ å…¥ï¼š

```toml
[profile.release]
debug = true
```

ç„¶åæ‰§è¡Œ:

```rust
$ cargo build --release
$ perf record -g target/release/perf-test
$ perf report
```

 å°±å¯ä»¥çœ‹åˆ°æŠ¥å‘Šäº†ã€‚

#### ç«ç„°å›¾å·¥å…·

ä½†æˆ‘ä»¬ Rust ç¨‹åºä¸­è¦é€šè¿‡[`flamegraph` ](https://crates.io/crates/flamegraph)crateï¼Œæ¥ç”Ÿæˆ ç«ç„°å›¾ï¼ˆflamegraphï¼‰ï¼Œå®ƒå¯ä»¥ä¸`cargo`ä¸€èµ·å·¥ä½œï¼Œéå¸¸æ–¹ä¾¿ã€‚

å› ä¸ºç«ç„°å›¾æœ‰åŠ©äºé˜…è¯»æºç ï¼Œå®ƒä»¥å¯è§†åŒ–çš„å›¾æ¡ˆéå¸¸æ˜ç¡®åœ°å±•ç¤ºè°ƒç”¨æ ˆä¹‹é—´çš„å…³ç³»ã€‚ç«ç„°å›¾å¯ä»¥è®©å¼€å‘è€…ä»æ•´ä½“ä¸Šçœ‹å‡ºå„ä¸ªçº¿ç¨‹çš„å¼€é”€æ¯”ä¾‹å’Œå­å‡½æ•°å æœ‰çš„æ¯”ä¾‹ï¼ŒæŒ‡å¼•æˆ‘ä»¬ä»æ•´ä½“ä¸Šæ‰¾åˆ°ä¼˜åŒ–çš„ä¼˜å…ˆçº§ã€‚

ç«ç„°å›¾ä¸­ï¼Œåœ¨è¢«æµ‹é‡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨çš„æ¯ä¸ªå‡½æ•°ä¼šè¢«è¡¨ç¤ºä¸ºä¸€ä¸ªçŸ©å½¢ï¼Œæ¯ä¸ªè°ƒç”¨æ ˆè¢«è¡¨ç¤ºä¸ºä¸€ä¸ªçŸ©å½¢æ ˆã€‚ä¸€ä¸ªç»™å®šçš„çŸ©å½¢çš„å®½åº¦ä¸åœ¨è¯¥å‡½æ•°ä¸­èŠ±è´¹çš„æ—¶é—´æˆæ­£æ¯”ï¼Œæ›´å®½çš„çŸ©å½¢æ„å‘³ç€æ›´å¤šçš„æ—¶é—´ã€‚ç«ç„°å›¾å¯¹äºè¯†åˆ«ç¨‹åºä¸­çš„æ…¢é€Ÿéƒ¨åˆ†éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è®©ä½ å¿«é€Ÿè¯†åˆ«ä»£ç åº“ä¸­å“ªäº›éƒ¨åˆ†èŠ±è´¹çš„æ—¶é—´ä¸æˆæ¯”ä¾‹ã€‚

ç”¨ Mongodb è°ƒä¼˜çš„ç¤ºä¾‹æ¥è¯´ï¼š

![4](./image/perf/4.png)

![5](./image/perf/5.png)

ç«ç„°å›¾ä¸­çš„æ ˆä»åº•éƒ¨å¼€å§‹ï¼Œéšç€è°ƒç”¨æ ˆçš„åŠ æ·±è€Œå‘ä¸Šç§»åŠ¨ï¼ˆå·¦å³æ— æ‰€è°“ï¼‰ï¼Œé€šå¸¸è¿™æ˜¯å¼€å§‹é˜…è¯»å®ƒä»¬çš„æœ€ä½³æ–¹å¼ã€‚çœ‹ä¸€ä¸‹ä¸Šé¢ç«ç„°å›¾çš„åº•éƒ¨ï¼Œæœ€å®½çš„çŸ©å½¢æ˜¯`Future::poll`ï¼Œä½†è¿™å¹¶ä¸æ˜¯å› ä¸ºRust çš„ `Future` è¶…çº§æ…¢ï¼Œè€Œæ˜¯å› ä¸ºæ¯ä¸ª`.await`éƒ½æ¶‰åŠè½®è¯¢ï¼ˆpollï¼‰`Future`ã€‚è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡ä»»ä½•è½®è¯¢çŸ©å½¢ï¼Œç›´åˆ°æˆ‘ä»¬åœ¨`mongodb`ä¸­çœ‹åˆ°æˆ‘ä»¬å…³å¿ƒçš„ä¿¡æ¯çš„å‡½æ•°ã€‚

è“è‰²æ–¹å—åŒ…å«äº†è°ƒç”¨`CommandResponse::body`æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œå®ƒæ˜¾ç¤ºå‡ ä¹æ‰€æœ‰çš„æ—¶é—´éƒ½èŠ±åœ¨äº†`clone()`ä¸Šã€‚å„ä¸ªç´«è‰²çŸ©å½¢å¯¹åº”çš„æ˜¯å°†`BSON`ï¼ˆMongoDBä½¿ç”¨çš„äºŒè¿›åˆ¶æ ¼å¼ï¼‰è§£æåˆ°`Document`ä¸­æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œç»¿è‰²çŸ©å½¢å¯¹åº”çš„æ˜¯`Document`çš„`serde::Deserialize`å®ç°ä¸­æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚æœ€åï¼Œé»‘è‰²è™šçº¿çŸ©å½¢å¯¹åº”çš„æ˜¯é‡Šæ”¾å†…å­˜çš„æ—¶é—´ï¼Œé»‘è‰²å®çº¿å¯¹åº”çš„æ˜¯å°†å‘½ä»¤åºåˆ—åŒ–ä¸º`BSON`çš„æ—¶é—´ã€‚

æ‰€ä»¥ä»ç«ç„°å›¾ä¸­åæ˜ å‡ºæ€§èƒ½ç“¶é¢ˆåœ¨äºï¼š

1. Clone è¿‡å¤šã€‚
2. åºåˆ—åŒ– bson è€—è´¹æ›´å¤šæ—¶é—´

ä¿®å¤å®Œè¿™äº›æ€§èƒ½ç“¶é¢ˆä¹‹åï¼Œå†ä½¿ç”¨åŸºå‡†æµ‹è¯•æµ‹è¯•ä¸€æ¬¡ã€‚

å¦‚æœå¯èƒ½çš„è¯ï¼Œå†ä½¿ç”¨ goose è¿™æ ·çš„å‹æµ‹å·¥å…·è¿›è¡Œä¸€æ¬¡è´Ÿè½½æµ‹è¯•æ›´å¥½ã€‚

#### perf é€‚åˆæµ‹è¯• Rust å¼‚æ­¥ä»£ç 

å¯¹äºå¼‚æ­¥ Rust ç¨‹åºè€Œè¨€ï¼Œç«ç„°å›¾çš„æ•ˆæœå¯èƒ½å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºå¼‚æ­¥è°ƒåº¦å™¨å’Œæ‰§è¡Œå™¨å‡ ä¹ä¼šå‡ºç°åœ¨ç«ç„°å›¾ä¸­æ¯ä¸€å—åœ°æ–¹ï¼Œçœ‹ä¸å‡ºç“¶é¢ˆæ‰€åœ¨ã€‚è¿™ä¸ªæ—¶å€™ä½¿ç”¨ perf å·¥å…·ä¼šæ›´åŠ æ¸…æ™°ã€‚

#### æ£€æŸ¥å†…å­˜æ³„éœ²å’Œä¸å¿…è¦çš„å†…å­˜åˆ†é…

å¯ä»¥ä½¿ç”¨ **[Valgrind](https://www.valgrind.org/)** å·¥å…·æ¥æ£€æŸ¥ç¨‹åºæ˜¯å¦å­˜åœ¨å†…å­˜æ³„éœ²ï¼Œæˆ–è€…åœ¨å…³é”®çš„è°ƒç”¨è·¯å¾„ä¸Šå­˜åœ¨ä¸å¿…è¦çš„å†…å­˜åˆ†é…ã€‚ 

ä¸ä»…ä»…è¦è€ƒå¯Ÿå †åˆ†é…ï¼Œä¹Ÿéœ€è¦è€ƒè™‘æ ˆä¸Šçš„åˆ†é…ï¼Œç‰¹åˆ«æ˜¯å¼‚æ­¥æ“ä½œæ—¶ã€‚

æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ Rust ç¼–è¯‘æ ‡å¿—ï¼ˆä»…åœ¨ Rust nightly ä¸­å¯ç”¨ï¼‰æ¥éªŒè¯æ•°æ®ç»“æ„æœ‰å¤šå¤§åŠå…¶ç¼“å­˜å¯¹é½ã€‚

```rust
$ RUSTFLAGS=-Zprint-type-sizes cargo build --release
```

é™¤äº†é€šå¸¸çš„ Cargo è¾“å‡ºä¹‹å¤–ï¼ŒåŒ…æ‹¬å¼‚æ­¥ Future åœ¨å†…çš„æ¯ä¸ªæ•°æ®ç»“æ„éƒ½ä»¥ç›¸åº”çš„å¤§å°å’Œç¼“å­˜å¯¹é½æ–¹å¼æ‰“å°å‡ºæ¥ã€‚æ¯”å¦‚ï¼š

```rust
print-type-size type: `net::protocol::proto::msg::Data`: 304 bytes, alignment: 8 bytes
print-type-size     field `.key`: 40 bytes
print-type-size     field `.data_info`: 168 bytes
print-type-size     field `.payload`: 96 bytes
```

Rust å¼‚æ­¥ç¼–ç¨‹éå¸¸ä¾èµ–æ ˆç©ºé—´ï¼Œå¼‚æ­¥è¿è¡Œæ—¶å’Œåº“éœ€è¦æŠŠæ‰€æœ‰ä¸œè¥¿æ”¾åˆ°æ ˆä¸Šæ¥ä¿è¯æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚å¦‚æœä½ çš„å¼‚æ­¥ç¨‹åºå ç”¨äº†è¿‡å¤šçš„æ ˆç©ºé—´ï¼Œå¯ä»¥è€ƒè™‘å°†å…¶è¿›è¡Œä¼˜åŒ–ä¸º å¹³è¡¡çš„åŒæ­¥å’Œå¼‚æ­¥ä»£ç ç»„åˆï¼ŒæŠŠç‰¹å®šçš„å¼‚æ­¥ä»£ç éš”ç¦»å‡ºæ¥ä¹Ÿæ˜¯ä¸€ç§ä¼˜åŒ–æ‰‹æ®µã€‚

#### å…¶ä»–æ€§èƒ½å‰–æ/ç›‘æ§å·¥å…·

å¦‚æœå…è®¸ï¼Œå¯ä»¥ä½¿ç”¨ è‹±ç‰¹å°”å‡ºå“çš„ [VTune ](https://www.intel.com/content/www/us/en/develop/documentation/vtune-help/top.html) å·¥å…·è¿›è¡Œ CPU æ€§èƒ½å‰–æã€‚

æˆ–è€…ä½¿ç”¨åœ¨çº¿çš„æ€§èƒ½ç›‘æ§å¹³å°ï¼Œæ¯”å¦‚ [Logrocket](https://logrocket.com/)ï¼Œæ”¯æŒ Rust ç¨‹åºï¼Œå¯ä»¥ç›‘æ§åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼ŒæŠ¥å‘Šå®¢æˆ·ç«¯ CPU è´Ÿè½½ã€å®¢æˆ·ç«¯å†…å­˜ä½¿ç”¨ç­‰æŒ‡æ ‡ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„é“¾è·¯è¿½è¸ªå·¥å…·æ¥ç›‘æ§ä½ è‡ªå·±çš„ Rust é¡¹ç›®ï¼šä½¿ç”¨ OpenTelemetry æ ‡å‡†ã€‚OpenTelemetry ä¹Ÿæ”¯æŒ Rust ã€‚

opentelemetryæ˜¯ä¸€æ¬¾æ•°æ®æ”¶é›†ä¸­é—´ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥ç”Ÿæˆï¼Œæ”¶é›†å’Œå¯¼å‡ºç›‘æµ‹æ•°æ®ï¼ˆMetrics,Logs and tracesï¼‰ï¼Œè¿™äº›æ•°æ®å¯ä¾›æ”¯æŒOpenTelemetryçš„ä¸­é—´ä»¶å­˜å‚¨ï¼ŒæŸ¥è¯¢å’Œæ˜¾ç¤ºï¼Œç”¨ä»¥å®ç°æ•°æ®è§‚æµ‹ï¼Œæ€§èƒ½åˆ†æï¼Œç³»ç»Ÿç›‘æ§ï¼ŒæœåŠ¡å‘Šè­¦ç­‰èƒ½åŠ›ã€‚

PingCAP ä¹Ÿå¼€æºäº†ä¸€æ¬¾é«˜æ€§èƒ½çš„ tracing åº“ : [minitrace-rust](https://github.com/tikv/minitrace-rust)

### Off-CPU æ€§èƒ½å‰–æ

Off-CPU æ˜¯æŒ‡åœ¨ I/Oã€é”ã€è®¡æ—¶å™¨ã€åˆ†é¡µ/äº¤æ¢ç­‰è¢«é˜»å¡çš„åŒæ—¶ç­‰å¾…çš„æ—¶é—´ã€‚

Off-CPU çš„æ€§èƒ½å‰–æé€šå¸¸å¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è¿›è¡Œé‡‡ç”¨é“¾è·¯è·Ÿè¸ªæ¥è¿›è¡Œåˆ†æã€‚

è¿˜æœ‰å°±æ˜¯ä½¿ç”¨ offcpu ç«ç„°å›¾è¿›è¡Œå¯è§†åŒ–è§‚å¯Ÿã€‚

![6](./image/perf/6.png)

è¿™é‡Œæ¨èçš„å·¥å…·æ˜¯ `eBPF`çš„å‰ç«¯å·¥å…·åŒ…[bcc](https://github.com/iovisor/bcc)ä¸­çš„`offcputime-bpfcc`å·¥å…·ã€‚

è¿™ä¸ªå·¥å…·çš„åŸç†æ˜¯åœ¨æ¯ä¸€æ¬¡å†…æ ¸è°ƒç”¨`finish_task_switch()`å‡½æ•°å®Œæˆä»»åŠ¡åˆ‡æ¢çš„æ—¶å€™è®°å½•ä¸Šä¸€ä¸ªè¿›ç¨‹è¢«è°ƒåº¦ç¦»å¼€`CPU`çš„æ—¶é—´æˆ³å’Œå½“å‰è¿›ç¨‹è¢«è°ƒåº¦åˆ°`CPU`çš„æ—¶é—´æˆ³ï¼Œé‚£ä¹ˆä¸€ä¸ªè¿›ç¨‹ç¦»å¼€`CPU`åˆ°ä¸‹ä¸€æ¬¡è¿›å…¥`CPU`çš„æ—¶é—´å·®å³ä¸º`Off-CPU`çš„æ—¶é—´ã€‚

æ¯”å¦‚è¿™é‡Œä¸€æ®µä»£ç ï¼š

```rust
use std::io::Read;
fn test1() {
    std::thread::sleep(std::time::Duration::from_nanos(200));
}
fn test2() {
    let mut f = std::fs::File::open("./1.txt").unwrap();
    let mut buffer = Vec::new();
    f.read_to_end(&mut buffer).unwrap();
}
fn main() {
    loop {
        test1();
        test2();
    }
}
```

ç¨‹åºä¸­ä¸€å…±æœ‰ä¸¤ç§ä¼šå¯¼è‡´è¿›ç¨‹è¢«è°ƒåº¦å‡º`CPU`çš„ä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯`test1()`å‡½æ•°ä¸­çš„`sleep()`ï¼Œä¸€ä¸ªæ˜¯åœ¨`test2()`å‡½æ•°ä¸­çš„è¯»æ–‡ä»¶æ“ä½œã€‚

è¿™é‡Œéœ€è¦ä½¿ç”¨debugç¼–è¯‘ï¼Œå› ä¸º`offcputime-bpfcc`ä¾èµ–äº`frame pointer`æ¥è¿›è¡Œæ ˆå±•å¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼€å¯`RUSTFLAGS="-C force-frame-pointers=yes"`çš„ç¼–è¯‘é€‰é¡¹ä»¥ä¾¿æ‰“å°å‡ºç”¨æˆ·æ€çš„å‡½æ•°æ ˆã€‚æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤è·å–`Off-CPU`çš„åˆ†ææ•°æ®ã€‚

```rust
$ ./target/debug/mytest & sudo offcputime-bpfcc -p `pgrep -nx mytest` 5
```

ç„¶åä½¿ç”¨ ç«ç„°å›¾å·¥å…·å°†å…¶ç”Ÿæˆ off-cpu ç«ç„°å›¾ï¼š

```rust
$ git clone https://github.com/brendangregg/FlameGraph
$ cd FlameGraph
$ sudo offcputime-bpfcc -df -p `pgrep -nx mytest` 3 > out.stacks
$ ./flamegraph.pl --color=io --title="Off-CPU Time Flame Graph" --countname=us < out.stacks > out.svg
```

å¾—åˆ°ä¸‹é¢ç«ç„°å›¾ï¼š

![7](./image/perf/7.png)

ä¸`On-CPU`çš„ç«ç„°å›¾ç›¸åŒï¼Œçºµè½´ä»£è¡¨äº†å‡½æ•°è°ƒç”¨æ ˆï¼Œæ¨ªè½´ä»£è¡¨äº†`Off-CPU`æ—¶é—´çš„æ¯”ä¾‹ï¼Œè·¨åº¦è¶Šå¤§ä»£è¡¨`Off-CPU`çš„æ—¶é—´è¶Šé•¿ã€‚

### å…¶ä»–é€‚åˆ Rust æ€§èƒ½å‰–æçš„å·¥å…·ä»‹ç»

é™¤äº† perf å’Œ ç«ç„°å›¾ å·¥å…·ï¼Œä¸‹é¢è¿˜æœ‰ä¸€äº› Rust ç¨‹åºé€‚ç”¨çš„å·¥å…·ã€‚

- [Hotspot](https://github.com/KDAB/hotspot)å’Œ[Firefox Profiler](https://profiler.firefox.com/)æ˜¯æŸ¥çœ‹perfè®°å½•çš„æ•°æ®çš„å¥½å·¥å…·ã€‚
- [Cachegrind](https://www.valgrind.org/docs/manual/cg-manual.html)å’Œ[Callgrind](https://www.valgrind.org/docs/manual/cl-manual.html)ç»™å‡ºäº†å…¨å±€çš„ã€æ¯ä¸ªå‡½æ•°çš„ã€æ¯ä¸ªæºçº¿çš„æŒ‡ä»¤æ•°ä»¥åŠæ¨¡æ‹Ÿçš„ç¼“å­˜å’Œåˆ†æ”¯é¢„æµ‹æ•°æ®ã€‚
- [DHAT](https://www.valgrind.org/docs/manual/dh-manual.html)å¯ä»¥å¾ˆå¥½çš„æ‰¾åˆ°ä»£ç ä¸­å“ªäº›éƒ¨åˆ†ä¼šé€ æˆå¤§é‡çš„åˆ†é…ï¼Œå¹¶å¯¹å³°å€¼å†…å­˜ä½¿ç”¨æƒ…å†µè¿›è¡Œæ·±å…¥äº†è§£ã€‚
- [heaptrack](https://github.com/KDE/heaptrack)æ˜¯å¦ä¸€ä¸ªå †åˆ†æå·¥å…·ã€‚
- [`counts`](https://github.com/nnethercote/counts/)æ”¯æŒå³å¸­ï¼ˆ*Ad Hoc*ï¼‰å‰–æï¼Œå®ƒå°†`eprintlnï¼`è¯­å¥çš„ä½¿ç”¨ä¸åŸºäºé¢‘ç‡çš„åå¤„ç†ç»“åˆèµ·æ¥ï¼Œè¿™å¯¹äºäº†è§£ä»£ç ä¸­ç‰¹å®šé¢†åŸŸçš„éƒ¨åˆ†å†…å®¹å¾ˆæœ‰å¸®åŠ©ã€‚
- [Coz](https://github.com/plasma-umass/coz)æ‰§è¡Œ*å› æœåˆ†æ*ä»¥è¡¡é‡ä¼˜åŒ–æ½œåŠ›ã€‚å®ƒé€šè¿‡[coz-rs](https://github.com/plasma-umass/coz/tree/master/rust)æ”¯æŒRustã€‚å› æœåˆ†ææŠ€æœ¯å¯ä»¥æ‰¾åˆ°ç¨‹åºçš„ç“¶é¢ˆå¹¶æ˜¾ç¤ºå¯¹å…¶è¿›è¡Œä¼˜åŒ–çš„æ•ˆæœã€‚

## æ—¥å¸¸ Rust å¼€å‘æ€§èƒ½ä¼˜åŒ–æŠ€å·§æ€»ç»“

è™½ç„¶æˆ‘ä»¬éœ€è¦é€šè¿‡å®Œå–„çš„æ€§èƒ½æµ‹è¯•æ–¹æ³•æ¥å‰–æç³»ç»Ÿä¸­å­˜åœ¨çš„ç“¶é¢ˆï¼Œä¿è¯ä¸ä¼šè¿‡æ—©ä¼˜åŒ–å’Œè¿‡åº¦ä¼˜åŒ–ã€‚ä½†æ˜¯åœ¨æ—¥å¸¸ç¼–ç è¿‡ç¨‹ä¸­ï¼ŒRust ç¤¾åŒºå†…ä¹Ÿæ€»ç»“å‡ºæ¥ä¸€äº›ä¼˜åŒ–æŠ€å·§æ¥ä¾›å‚è€ƒï¼š

### 1. å¯¹äºåªè¢«è°ƒç”¨ä¸€æ¬¡çš„å‡½æ•°å¯èƒ½å¹¶ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚

æ¯”å¦‚è¯»å–é…ç½®æ–‡ä»¶ï¼Œè¿™ç§å¤šæ…¢éƒ½æ²¡æœ‰å…³ç³»ã€‚

ä¸è¦åªä¼˜åŒ–ç¨‹åºä¸­æœ€æ…¢çš„å‡½æ•°ï¼Œè¦ä¼˜åŒ–å ç”¨å¤§éƒ¨åˆ†è¿è¡Œæ—¶é—´çš„å‡½æ•°ã€‚

åœ¨ä¸€ä¸ªè¢«è°ƒç”¨ 1000 æ¬¡çš„å‡½æ•°ä¸Šå¾—åˆ° 2 æ¯«ç§’çš„æ”¹è¿›ï¼Œé‚£æ¯”åœ¨ä¸€ä¸ªè¢«è°ƒç”¨ä¸€æ¬¡çš„å‡½æ•°ä¸Šè·å¾— 1 ç§’çš„æ”¹è¿›è¦å¥½ã€‚

### 2. ä¼˜å…ˆæ”¹è¿›ä½ çš„ç®—æ³•

å¾ˆå¤šæ—¶å€™æ€§èƒ½ä¸ä½³ï¼Œå¾ˆå¯èƒ½æ˜¯ç”±äºç®—æ³•ä¸ä½³è€Œä¸æ˜¯å®ç°ä¸ä½³ã€‚è¯·æ£€æŸ¥ä½ çš„ä»£ç ä¸­å¾ªç¯çš„ä½¿ç”¨ï¼Œåªéœ€å°è¯•å°½å¯èƒ½å°‘çš„å¾ªç¯ã€‚

1. è®°ä½æ¯æ¬¡ä½¿ç”¨`collect`å¿…é¡»è‡³å°‘ä¼šè¿­ä»£æ•´ä¸ªé›†åˆä¸€æ¬¡ï¼Œæ‰€ä»¥æœ€å¥½åª collect ä¸€æ¬¡ã€‚
2. è­¦æƒ•ä½ ä½¿ç”¨çš„æ ‡å‡†åº“æ–¹æ³•å’Œç¬¬ä¸‰æ–¹åº“æ–¹æ³•å†…éƒ¨å®ç°ä¸­éšè—çš„å¾ªç¯ã€‚

### 3. è¦å……åˆ†ç†è§£ Rust ä¸­æ•°æ®ç»“æ„çš„å†…å­˜å¸ƒå±€

è¦å­¦ä¼šåŒºåˆ† Rust ä¸­æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€ï¼Œå®ƒä»¬åœ¨æ ˆä¸Šå’Œå †ä¸Šå¦‚ä½•åˆ†é…çš„ã€‚

æ¯”å¦‚ `String`ï¼Œ`Vec`ï¼Œ`HashMap`å’Œ`Box<Trait>`/`Box<[T]>`æ‰€æœ‰åˆ†é…éƒ½åœ¨å †ä¸Šã€‚

åœ¨æ ˆä¸Šåˆ†é…çš„æ•°æ®ï¼Œç§»åŠ¨çš„æ—¶å€™åªèƒ½æ˜¯ æŒ‰ä½å¤åˆ¶çš„æ–¹å¼ã€‚æ‰€ä»¥å³ä¾¿å†…å­˜æ˜¯åœ¨æ ˆä¸Šåˆ†é…ï¼Œä¹Ÿè¦è€ƒè™‘è¿™ä¸ª Copy çš„æˆæœ¬ã€‚

å †ä¸Šçš„æ•°æ®ï¼Œè¦å°½å¯èƒ½åœ°é¿å…æ·±æ‹·è´ï¼ˆæ˜¾å¼ Cloneï¼‰ ã€‚

å¹¶ä¸”è¦å°½å¯èƒ½åœ°ç¼“å­˜æ•°æ®ï¼Œè€Œé¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…å‘ç”Ÿã€‚æ¯”å¦‚å¯ä»¥ä½¿ç”¨è¯¸å¦‚ slab ä¹‹ç±»çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå¯ä»¥åˆç†å¤ç”¨å†…å­˜ã€‚

### 4. é¿å… `Box<Trait>` åŠ¨æ€åˆ†å‘

åˆ›å»º trait å¯¹è±¡çš„è§„èŒƒæ–¹æ³•æ˜¯`Box<Trait>`ï¼Œä½†å¤§å¤šæ•°ä»£ç éƒ½å¯ä»¥ä½¿ç”¨`&mut Trait`ï¼Œå®ƒä¹Ÿå…·æœ‰åŠ¨æ€åˆ†æ´¾ä½†èŠ‚çœäº†åˆ†é…ã€‚å¦‚æœæ‚¨ç»å¯¹éœ€è¦æ‰€æœ‰æƒï¼Œè¯·ä½¿ç”¨`Box`ï¼Œä½†å¤§å¤šæ•°ç”¨ä¾‹éƒ½å¯ä»¥ä½¿ç”¨`&Trait`æˆ–`&mut Trait`ã€‚

æœ‰äº›åœºæ™¯ä¹Ÿå¯ä»¥ä½¿ç”¨ Enum æ¥ä»£æ›¿ trait å¯¹è±¡ã€‚å‚è§ [`enum_dispatch`](https://docs.rs/enum_dispatch/latest/enum_dispatch/)ã€‚

### 5. ä½¿ç”¨åŸºäºæ ˆçš„å¯å˜é•¿åº¦æ•°æ®ç±»å‹

å®šé•¿åº¦çš„æ•°æ®ç±»å‹å¯ä»¥ç®€å•åœ°å­˜å‚¨åœ¨å †æ ˆä¸Šï¼Œä½†å¯¹äºåŠ¨æ€å¤§å°çš„æ•°æ®ï¼Œå®ƒå¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚ä½†æ˜¯ï¼Œ[`smallvec`](https://github.com/servo/rust-smallvec), [`smallstring`](https://github.com/jFransham/smallstring)å’Œ[`tendril`](https://github.com/servo/tendril)éƒ½æ˜¯å¯å˜é•¿åº¦æ•°æ®ç±»å‹ï¼Œå…è®¸åœ¨æ ˆä¸Šå­˜å‚¨å°‘é‡å…ƒç´ ã€‚åƒ`smallvec`è¿™æ ·çš„åº“éå¸¸é€‚åˆç¼“å­˜å±€éƒ¨æ€§ï¼Œå¯ä»¥å‡å°‘åˆ†é…ã€‚

```rust
// This is a gross oversimplification of how this type is implemented in the// crate, but it's enough to explain how it works.enum SmallVec<T> {    Small([T; 4]),    Big(Vec<T>),}type Matrix<T> = SmallVec<SmallVec<T>>;
```

### 6. åˆç†ä½¿ç”¨æ–­è¨€é¿å…æ•°ç»„è¶Šç•Œæ£€æŸ¥

Safe Rust ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨å¡å…¥æ•°ç»„è¶Šç•Œæ£€æŸ¥ï¼Œæ¯”å¦‚ä¸‹é¢ä»£ç ï¼š

```rust
fn do_something_with_array(array: &[u8]) -> u8 {    array[0] + array[1] + array[2] + array[3] + array[4] + array[5]}
```

å¯ä»¥é€šè¿‡ç¼–è¯‘è¾“å‡º MIR çœ‹åˆ°ï¼Œç¼–è¯‘å™¨ä¼šç»™æ•°ç»„ç´¢å¼•è®¿é—®æ’å…¥æ–­è¨€æ£€æŸ¥ï¼š

```rust
assert(move _9, "index out of bounds: the length is {} but the index is {}", move _8, _7) 
```

æœ‰å‡ ä¸ªæ•°ç»„ç´¢å¼•è®¿é—®å°±ä¼šè¢«æ’å…¥å‡ æ¬¡ï¼Œä¸Šé¢çš„ä»£ç ä¼šè¢«æ’å…¥ 6 æ¬¡ï¼Œè¿™æå¤§å½±å“æ€§èƒ½ã€‚

![8](./image/perf/8.png)

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰‹å·¥æ’å…¥ä¸€æ¬¡æ–­è¨€æ£€æŸ¥ï¼Œå°±å¯ä»¥æ¶ˆé™¤ç¼–è¯‘å™¨çš„è‡ªåŠ¨æ’å…¥ã€‚

```rust
fn do_something_with_array(array: &[u8]) -> u8 {    assert!(array.len >= 5);    array[0] + array[1] + array[2] + array[3] + array[4] + array[5]}
```

è¿™ä¸€æ¡ä¹Ÿæ˜¯å¯ä»¥ä¸¾ä¸€åä¸‰çš„ï¼Œæ¯”å¦‚ Rust ä¹Ÿä¼šä¸ºæ™®é€šçš„åŠ æ³•æ“ä½œæ·»åŠ é˜²æ­¢è®¡ç®—æº¢å‡ºçš„æ–­è¨€ï¼Œä½†æ˜¯ä½ å¦‚ä½•æ‰‹å·¥ä½¿ç”¨äº† wrapped_add ä¹‹ç±»çš„æ–¹æ³•ï¼Œé‚£å°±å¯ä»¥é¿å…ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥è¿™ç±»æ–­è¨€ã€‚

### 7. ä½¿ç”¨é“¾æ¥æ—¶ä¼˜åŒ–ï¼ˆLTOï¼‰

é“¾æ¥æ—¶ä¼˜åŒ–å…è®¸ç¼–è¯‘å™¨è·¨ crate è¿›è¡Œå†…è”ï¼Œä½†æ˜¯è¿™æ ·åšçš„ä»£ä»·æ˜¯å‡æ…¢ç¼–è¯‘æ—¶é—´ã€‚ä½†æˆ‘è®¤ä¸ºï¼Œç¼–è¯‘æ—¶é—´å¦‚ä½•èƒ½æ¢å–æ€§èƒ½æå‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶é—´å€¼å¾—ç‰ºç‰²ã€‚

### 8. ä¸è¦ä½¿ç”¨ `#[inline(always)]`

Rust ç¼–è¯‘å™¨è‡ªèº«çš„ä¼˜åŒ–å¯ä»¥è®¡ç®—å‡ºä½•æ—¶éœ€è¦å†…è”ä¸€äº›å‡½æ•°ï¼Œä¸éœ€è¦ä½ æ‰‹å·¥æ˜ç¡®æŒ‡å®šã€‚é™¤éè¿™ä¸ªå‡½æ•°è°ƒç”¨ååˆ†é¢‘ç¹ã€‚

å› ä¸ºè¿™ç§æ˜¾å¼çš„æŒ‡å®šä¼šå¯¼è‡´ç¼–è¯‘å¤§å°çš„è†¨èƒ€ï¼Œå¦‚æœä½ çš„ç¡¬ä»¶èµ„æºä¸å—é™å¯èƒ½ä¸å¤ªé‡è¦ã€‚ä½†æ˜¯å¯¹äºèµ„æºå—é™çš„ç¯å¢ƒï¼Œæ¯”å¦‚åµŒå…¥å¼ï¼Œåˆ™éœ€è¦è¿›è¡Œæƒè¡¡ã€‚

å¯¹äºä¸€äº›å°çš„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ LTOï¼Œä½†æ˜¯éœ€è¦è·¨ crate å†…è”çš„è¯ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®š `#[inline]`ã€‚

### 9. é¿å…æ˜¾å¼ Clone

å°½å¯èƒ½åœ°ä½¿ç”¨å¼•ç”¨ï¼Œé¿å…è¿‡å¤šçš„ Clone ã€‚å› ä¸ºClone å¯èƒ½ä¼´éšå†…å­˜åˆ†é…ã€‚

### 10. ä½¿ç”¨ Unsafe æ–¹æ³•æ¶ˆé™¤ä¸€äº›ä¸å¿…è¦çš„å®‰å…¨æ£€æŸ¥

åœ¨ Rust æ ‡å‡†åº“ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å¾ˆå¤š `_unchecked`åç¼€çš„æ–¹æ³•ã€‚

æ¯”å¦‚ `String::from_utf8` å’Œ `String::from_utf8_unchecked`ï¼Œæ˜¯ä¸€å¯¹ Safe å’Œ Unsafe çš„æ–¹æ³•ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨ `String::from_utf8`  å°† `u8`åºåˆ—è½¬æ¢ä¸ºåˆæ³•çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹ `u8`åºåˆ—è¿›è¡Œäº†åˆæ³• utf8ç¼–ç çš„æ£€æŸ¥ã€‚ä½†æ˜¯è¿™ä¸ªæ£€æŸ¥ä¹Ÿä¼šæœ‰ä¸€å®šå¼€é”€ã€‚

å¦‚æœå¼€å‘è€…èƒ½ç¡®ä¿è°ƒç”¨ç¯å¢ƒçš„ `u8`åºåˆ—æ¥æºæ˜¯å®Œå…¨åˆæ³•çš„ utf8 ç¼–ç ï¼Œé‚£ä¹ˆè¿™ä¸ªå®‰å…¨æ£€æŸ¥å°±å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨  `String::from_utf8_unchecked` æ¥æ›¿æ¢  `String::from_utf8` ç”¨æ¥æå‡æ€§èƒ½ã€‚

```rust
pub fn from_utf8(vec: Vec<u8>) -> Result<String, FromUtf8Error> {    match str::from_utf8(&vec) {        Ok(..) => Ok(String { vec }),        Err(e) => Err(FromUtf8Error { bytes: vec, error: e }),    }}pub unsafe fn from_utf8_unchecked(bytes: Vec<u8>) -> String {    String { vec: bytes }}
```

### 11. å¹¶å‘/å¹¶è¡ŒåŒ–ä½ çš„ç¨‹åº

ç”¨ Rust å†™å¤šçº¿ç¨‹å’Œå¼‚æ­¥å¹¶å‘ç¨‹åºæ˜¯éå¸¸ä¾¿åˆ©çš„ã€‚

æ¨èçš„åº“æœ‰å¾ˆå¤šï¼š

- [rayon](https://github.com/rayon-rs/rayon)ï¼Œå¹¶è¡Œè¿­ä»£å™¨
- [crossbeam](https://docs.rs/crossbeam/latest/crossbeam/) / [flume](https://github.com/zesterer/flume)ï¼Œå¤šçº¿ç¨‹channel/ æ— é”å¹¶å‘ç»“æ„
- [Tokio](https://github.com/tokio-rs/tokio) ï¼Œé«˜æ€§èƒ½å¼‚æ­¥è¿è¡Œæ—¶
  - [loom](https://github.com/tokio-rs/loom)ï¼Œ Tokio æä¾›çš„å¹¶å‘ä»£ç æµ‹è¯•å·¥å…·ï¼Œæ”¯æŒ C11 å†…å­˜æ¨¡å‹ã€‚
  - [console](https://github.com/tokio-rs/console)ï¼ŒTokio æä¾›çš„ Rust å¼‚æ­¥è¯Šæ–­å’Œè°ƒè¯•å·¥å…·ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºå¼‚æ­¥ä»£ç çš„ Clippyã€‚é€šè¿‡ç›‘æ§åº”ç”¨ç¨‹åºä¸­ä»»åŠ¡çš„è¿è¡Œæ—¶æ“ä½œï¼Œå¯ä»¥æ£€æµ‹*å¯èƒ½*æš—ç¤ºé”™è¯¯æˆ–æ€§èƒ½é—®é¢˜çš„è¡Œä¸ºæ¨¡å¼ï¼Œå¹¶çªå‡ºæ˜¾ç¤ºå®ƒä»¬ä»¥ä¾›ç”¨æˆ·åˆ†æã€‚
- è·¨å¹³å° SIMDï¼Œå¹¶è¡ŒåŒ–ä½ çš„è®¡ç®—ã€‚

### 12.  å¹¶å‘ç¨‹åºä¸­ï¼Œåˆç†ä½¿ç”¨é”ï¼Œæˆ–æ›¿æ¢æ— é”æ•°æ®ç»“æ„

åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå¯èƒ½è¯»å¹¶å‘è®¿é—®è¦æ¯”å†™å¹¶å‘æ›´é¢‘ç¹ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ è¯»å†™é”æ¥æ›¿æ¢äº’æ–¥é”ã€‚å¦å¤–ï¼Œä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ parking_lot ä¸­å®šä¹‰çš„å¹¶å‘é”æ¥ä»£æ›¿æ ‡å‡†åº“ä¸­çš„é”ã€‚

æˆ–è€…åˆç†é€‰æ‹©æ— é”æ•°æ®ç»“æ„æ¥æ›¿æ¢ç”¨é”æ¥åŒæ­¥çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸æ˜¯è¯´æ— é”ä¸€å®šæ¯”é”åŒæ­¥æ€§èƒ½æ›´å¥½ï¼Œä¹Ÿæ˜¯éœ€è¦çœ‹åœºæ™¯å’Œé€‰æ‹©é«˜è´¨é‡çš„ç¬¬ä¸‰æ–¹å®ç°ã€‚

### 13. ä½¿ç”¨ Clippy 

ä½¿ç”¨ Clippy å·¥å…·å¯¹ä»£ç è¿›è¡Œé™æ€åˆ†æï¼Œå®ƒå¯ä»¥é’ˆå¯¹æ€§èƒ½æ”¹è¿›æä¾›ä¸€äº›å»ºè®®ã€‚

å…³äº Clippy æ€§èƒ½æ”¹è¿› lint å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š[https://rust-lang.github.io/rust-clippy/master/index.html](https://rust-lang.github.io/rust-clippy/master/index.html)

åŒæ ·å¯ä»¥éµå¾ª [ Rust ç¼–ç è§„èŒƒ ](https://rust-coding-guidelines.github.io/rust-coding-guidelines-zh/) ä¸­çš„ä¸€äº›è§„èŒƒï¼Œä¹Ÿä¼šåŒ…æ‹¬ Clippy çš„ä¸€äº›å»ºè®®ã€‚å¦‚æœä½ æœ‰ä»€ä¹ˆæ€§èƒ½ä¼˜åŒ–çš„å°æŠ€å·§ï¼Œæ¬¢è¿æäº¤è´¡çŒ®ã€‚

## ç¼–è¯‘å¤§å°å’Œç¼–è¯‘æ—¶é—´çš„ä¼˜åŒ–æ€»ç»“

### 1. ä¼˜åŒ–ç¼–è¯‘å¤§å°

- è®¾ç½® codegen-units=1 ï¼Œcodegen-units å«åšä»£ç ç”Ÿæˆå•å…ƒï¼ŒRust ç¼–è¯‘å™¨ä¼šæŠŠcrate ç”Ÿæˆçš„ LLVMIRè¿›è¡Œåˆ†å‰²ï¼Œé»˜è®¤åˆ†å‰²ä¸º16ä¸ªå•å…ƒï¼Œæ¯ä¸ªå•å…ƒå°±å« codegen-unitsï¼Œå¦‚æœåˆ†å‰²çš„å¤ªå¤šï¼Œå°±ä¸åˆ©äº Rustç¼–è¯‘å™¨ä½¿ç”¨å†…è”ä¼˜åŒ–ä¸€äº›å‡½æ•°è°ƒç”¨ï¼Œåˆ†å‰²å•å…ƒè¶Šå¤§ï¼Œæ‰è¶Šå®¹æ˜“åˆ¤æ–­éœ€è¦å†…è”çš„åœ°æ–¹ã€‚ä½†æ˜¯è¿™ä¹Ÿæœ‰å¯èƒ½å¢å¤§ç¼–è¯‘æ–‡ä»¶å¤§å°ï¼Œéœ€è¦å¤§å°å’Œæ€§èƒ½é—´å¯»æ‰¾å¹³è¡¡ã€‚
- è®¾ç½®panic=abortã€‚å¯ä»¥ç¼©å‡ç¼–è¯‘æ–‡ä»¶çš„å¤§å°ã€‚
- è®¾ç½®ç¼–è¯‘ä¼˜åŒ–ç­‰çº§ä¸º `z`ï¼Œæ„ä¸ºæœ€å°äºŒè¿›åˆ¶ä½“ç§¯ã€‚ç¼–è¯‘å™¨çš„ä¼˜åŒ–çº§åˆ«å¯¹åº”çš„æ˜¯`LLVM`å‡½æ•°å†…è”çš„é˜ˆå€¼ï¼Œ`z` å¯¹åº”çš„æ˜¯ 25ï¼Œè€Œ çº§åˆ« `3`åˆ™å¯¹åº” 275 ã€‚
- è¯„ä¼°ä»£ç ä¸­æ³›å‹å’Œå®çš„ä½¿ç”¨ï¼Œæ˜¯å¦å¯ä»¥ç²¾ç®€
- å…¶ä»–å‚è€ƒï¼šhttps://github.com/johnthagen/min-sized-rust

### 2. ä¼˜åŒ–ç¼–è¯‘å¤§å°çš„ä¸€äº›æŠ€å·§

- ä½¿ç”¨ cargo check ä»£æ›¿ cargo build

- ä½¿ç”¨æœ€æ–° Rust å·¥å…·é“¾

- ä½¿ç”¨ Rust Analyzer è€Œä¸æ˜¯ Rust Language Server (RLS)

- åˆ é™¤æœªä½¿ç”¨çš„ä¾èµ–é¡¹

- æ›¿æ¢ä¾èµ–è¿‡å¤šçš„ç¬¬ä¸‰æ–¹åº“

- ä½¿ç”¨ workspaceï¼Œå°†é¡¹ç›®æ‹†åˆ†ä¸ºå¤šä¸ªcrateï¼Œæ–¹ä¾¿å¹¶è¡Œç¼–è¯‘

- å°†é’ˆå¯¹æ¨¡å—çš„æµ‹è¯•å•ç‹¬æ‹†åˆ†ä¸ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶

- å°†æ‰€æœ‰é›†æˆæµ‹è¯•ç»„åˆåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­

- ç¦æ­¢ crate ä¾èµ–æœªä½¿ç”¨åŠŸèƒ½

- ä½¿ç”¨ ssdæˆ–Ramdiskï¼ˆè™šæ‹Ÿå†…å­˜ç›˜ï¼‰ è¿›è¡Œç¼–è¯‘

- ä½¿ç”¨ [sccache](https://github.com/mozilla/sccache) ç¼“å­˜ä¾èµ–é¡¹

- åˆ‡æ¢åˆ°æ›´å¿«çš„é“¾æ¥å™¨ï¼š[mold](https://github.com/rui314/mold) ï¼ˆLinuxï¼‰/ [zld](https://github.com/michaeleisel/zld) (MacOS) /  ğŸ¤· (Windows)ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥é“¾æ¥æ‰€èŠ±æ—¶é—´ï¼š

  ```rust
  cargo cleancargo +nightly rustc --bin <your_binary_name> -- -Z time-passes
  ```

- Rust é’ˆå¯¹ MacOS ç”¨æˆ·ä¹Ÿæå‡äº†å¢é‡ç¼–è¯‘æ€§èƒ½ï¼Œåœ¨ Cargo.toml ä¸­è¿›è¡Œä»¥ä¸‹é…ç½®ï¼š

- ```rust
  [profile.dev]split-debuginfo = "unpacked"
  ```

- è°ƒæ•´æ›´å¤š Codegen é€‰é¡¹/ç¼–è¯‘å™¨æ ‡å¿—ã€‚è¿™æ˜¯[å®Œæ•´çš„ codegen é€‰é¡¹åˆ—è¡¨](https://doc.rust-lang.org/rustc/codegen-options) ã€‚ä¸ºäº†è·å¾—çµæ„Ÿï¼Œè¿™é‡Œæ˜¯[bevy çš„ç”¨äºæ›´å¿«ç¼–è¯‘çš„é…ç½®](https://github.com/bevyengine/bevy/blob/3a2a68852c0a1298c0678a47adc59adebe259a6f/.cargo/config_fast_builds)ã€‚

- å‰–ææ–‡ä»¶ç¼–è¯‘æ—¶é—´ã€‚ä½¿ç”¨ [`cargo rustc -- -Zself-profile`](https://blog.rust-lang.org/inside-rust/2020/02/25/intro-rustc-self-profile.html#profiling-the-compiler)ç”Ÿæˆçš„è·Ÿè¸ªæ–‡ä»¶å¯ä»¥ä½¿ç”¨ç«ç„°å›¾æˆ– Chromium åˆ†æå™¨è¿›è¡Œå¯è§†åŒ–ã€‚è¿˜æœ‰ä¸€ä¸ª[`cargo -Z timings`](https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#timings)åŠŸèƒ½å¯ä»¥æä¾›æœ‰å…³æ¯ä¸ªç¼–è¯‘æ­¥éª¤éœ€è¦å¤šé•¿æ—¶é—´çš„ä¸€äº›ä¿¡æ¯ï¼Œå¹¶éšç€æ—¶é—´çš„æ¨ç§»è·Ÿè¸ªå¹¶å‘ä¿¡æ¯ã€‚

- é¿å…è¿‡ç¨‹å® Cratesï¼Œä¸»è¦æ˜¯å› ä¸ºä½¿ç”¨äº† syn ã€‚è¿‡ç¨‹å®æ˜¯ Rust å¼€å‘çš„çƒ­ç‚¹ï¼šå®ƒä»¬ä¼šæ¶ˆè€— CPU å‘¨æœŸï¼Œå› æ­¤è¯·è°¨æ…ä½¿ç”¨ã€‚serde åº“ä¸­åŒ…å«äº†è¿‡ç¨‹å®ï¼Œå®ƒåœ¨å¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„æ˜¯å¦ä¸€å®šéœ€è¦serde è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

- é¿å…è¿‡å¤šçš„æ³›å‹ã€‚è¿‡å¤šçš„æ³›å‹å•æ€åŒ–ä¹Ÿä¼šå¯¼è‡´ç¼–è¯‘æ—¶é—´å¢åŠ ã€‚

- æå‡ä½ çš„ç¡¬ä»¶ï¼Œæˆ–è€…åœ¨äº‘ç«¯ï¼ˆæ¯”å¦‚[Gitpod.io](https://gitpod.io/)ï¼Œå¯å…è´¹ä½¿ç”¨ 16 æ ¸ Intel Xeon 2.80GHzï¼Œ60GB RAMçš„ä¸»æœºï¼‰ä½¿ç”¨æ›´å¥½çš„ç¡¬ä»¶ç¯å¢ƒè¿›è¡Œç¼–è¯‘ã€‚

- ä¸‹è½½æ‰€æœ‰çš„ä¾èµ– crateã€‚ç¼–è¯‘è¿‡ç¨‹ä¸­æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ—¶é—´ç”¨äºä¸‹è½½ï¼Œæå‰ä¸‹è½½å¥½crateæ˜¯æœ‰å¸®åŠ©çš„ã€‚å‚è€ƒ https://github.com/the-lean-crate/criner

- ä½¿ç”¨ docker è¿›è¡Œç¼–è¯‘ã€‚[`cargo-chef`](https://www.lpalmieri.com/posts/fast-rust-docker-builds/)å¯ç”¨äºå……åˆ†åˆ©ç”¨ Docker å±‚ç¼“å­˜ï¼Œä»è€Œå¤§å¤§åŠ å¿« Rust é¡¹ç›®çš„ Docker æ„å»ºã€‚

- è¶…é¢‘ cpu ï¼Ÿè°¨æ…ã€‚

- ä¼˜åŒ– CI æ„å»ºé€Ÿåº¦ã€‚å‚è€ƒ https://matklad.github.io/2021/09/04/fast-rust-builds.htmlã€‚

- ä½ è‡ªå·±å¼€å‘ crate çš„æ—¶å€™å°½é‡ä¿æŒç²¾ç®€ï¼Œåˆ©äººåˆ©å·±ã€‚



## å‚è€ƒ

1. [https://zenoh.io/blog/2021-07-13-zenoh-performance-async/](https://zenoh.io/blog/2021-07-13-zenoh-performance-async/)

2. [https://bheisler.github.io/criterion.rs/book/getting_started.html](https://bheisler.github.io/criterion.rs/book/getting_started.html)

3. [https://rust-coding-guidelines.github.io/rust-coding-guidelines-zh/safe-guides/Appendix/test/benchmark.html#%E7%94%A8-cargo-bench-%E5%92%8C-criterionrs-%E6%9D%A5%E6%89%A7%E8%A1%8C%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95](https://rust-coding-guidelines.github.io/rust-coding-guidelines-zh/safe-guides/Appendix/test/benchmark.html#%E7%94%A8-cargo-bench-%E5%92%8C-criterionrs-%E6%9D%A5%E6%89%A7%E8%A1%8C%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95)

4. [https://gist.github.com/jFransham/369a86eff00e5f280ed25121454acec1](https://gist.github.com/jFransham/369a86eff00e5f280ed25121454acec1)

5. [https://github.com/tag1consulting/goose](https://github.com/tag1consulting/goose)

6. [https://rustmagazine.github.io/rust_magazine_2021/chapter_11/rust-profiling.html?search=](https://rustmagazine.github.io/rust_magazine_2021/chapter_11/rust-profiling.html?search=)

7. [https://rustmagazine.github.io/rust_magazine_2021/chapter_7/paper-rust-vs-c.html](https://rustmagazine.github.io/rust_magazine_2021/chapter_7/paper-rust-vs-c.html)

8. [https://blues-star.github.io/perf-book-zh/benchmarking_zh.html](https://blues-star.github.io/perf-book-zh/benchmarking_zh.html)

9. [https://en.pingcap.com/blog/how-we-trace-a-kv-database-with-less-than-5-percent-performance-impact/](https://en.pingcap.com/blog/how-we-trace-a-kv-database-with-less-than-5-percent-performance-impact/)

10. [https://rust-coding-guidelines.github.io/rust-coding-guidelines-zh/](https://rust-coding-guidelines.github.io/rust-coding-guidelines-zh/)

11. [https://endler.dev/2020/rust-compile-times/](https://endler.dev/2020/rust-compile-times/)

12. [https://github.com/johnthagen/min-sized-rust](https://github.com/johnthagen/min-sized-rust)

13. [https://docs.rust-embedded.org/book/unsorted/speed-vs-size.html](https://docs.rust-embedded.org/book/unsorted/speed-vs-size.html)

14. [https://fasterthanli.me/articles/why-is-my-rust-build-so-slow](https://fasterthanli.me/articles/why-is-my-rust-build-so-slow)

    

    

    

    







