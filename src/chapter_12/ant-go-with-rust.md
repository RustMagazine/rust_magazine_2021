# èš‚èšé›†å›¢ | ä¸€æ¬¡ Go ä½¿ç”¨åµŒå…¥å¼ Rust åº“çš„è¸©å‘å®è·µ

ä½œè€…ï¼šRuihangXia 

--- 

## èƒŒæ™¯

æ•…äº‹å‘ç”Ÿåœ¨ä¸€ä¸ªå†…éƒ¨é¡¹ç›®ä¸Šï¼Œè¿™ä¸ªé¡¹ç›®æœ‰ Go å’Œ Rust ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­ Rust åº“ä½œä¸ºä¸€ä¸ªå­˜å‚¨ç»„ä»¶è¢« Go çš„ä¸šåŠ¡éƒ¨åˆ†ä¾èµ–ç€ã€‚å‡ºäºç§ç§åŸå› ï¼Œä¸¤ä¸ªéƒ¨åˆ†éœ€è¦ä½œä¸ºåŒä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œï¼Œä¸­é—´æœ‰ä¸€å±‚ C FFI æ¥å£ä½œä¸ºç†æƒ³ä¸ç°å®çš„æ¡¥æ¢ã€‚å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­çš„

![img](./image/ant/1.png)

Rust éƒ¨åˆ†é¦–å…ˆå°†ä½¿ç”¨åˆ°çš„ Library çš„æ¥å£å’Œç»“æ„ä½¿ç”¨å¦ä¸€ä¸ªå°å°çš„ cdylib [1] shim é¡¹ç›®å°è£…ä¸€ä¸‹ï¼Œå¹¶é€šè¿‡è¿™ä¸ªé¡¹ç›®ç”Ÿæˆ Rust åº“çš„ç¼–è¯‘äº§ç‰©ä¸€ä¸ªåŠ¨æ€é“¾æ¥å¯¹è±¡å’Œ C çš„æ¥å£å®šä¹‰ã€‚å†åŸºäº C çš„å®šä¹‰å†™ä¸€ä¸ª Go çš„ SDK ç»™ä¸Šå±‚ä½¿ç”¨ã€‚å•ç‹¬çš„å·¦è¾¹ Go æˆ–è€…å³è¾¹ Rust é¡¹ç›®éƒ½ä¸å¤Ÿåˆºæ¿€ï¼Œæœ¬æ–‡ä¸»è¦é›†ä¸­åœ¨ä¸­é—´é‚£ä¸€å›¢éº»èŠ±çš„éƒ¨åˆ†ä¸Šï¼Œä¹Ÿæ˜¯æˆ‘ too young too simple æ‰äº†å¾ˆå¤šå¤´å‘çš„åœ°æ–¹ã€‚

æœ¬æ–‡ä»çº¿ç¨‹ã€å†…å­˜å’Œä¿¡å·ä¸‰ä¸ªå¤§æ¦‚çš„æ–¹é¢è®²å‡ ä¸ªäº‹æ•…ã€‚

## çº¿ç¨‹

åˆšå¼€å§‹çš„æ—¶å€™ shim å’Œ SDK éƒ½éå¸¸ç®€å•ï¼ŒSDK æ¯ä¸ªè¯·æ±‚éƒ½é€šè¿‡ cgo èµ°åˆ° shimï¼Œshim åœ¨è¿›è¡Œä¸€äº›ç»“æ„çš„è½¬æ¢åè°ƒç”¨ library æ¥å¤„ç†è¯·æ±‚ï¼Œç­‰å¾…è¯·æ±‚å®Œæˆä¹‹åæŠŠç»“æœè¿”å›ç»™ SDKã€‚æ¯”è¾ƒç¬¦åˆç›´è§‰çš„æµç¨‹ï¼Œä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™å‡ºç°äº†é—®é¢˜ï¼Œæ•´ä¸ªç¨‹åºçš„è¡Œä¸ºéƒ½ä¸å¤ªæ­£å¸¸ã€‚å½“æ—¶åˆšå¼€å§‹è¿è°ƒï¼Œåœ¨è¿™ä¹‹å‰ component å’Œ library/shim éƒ½åªè¿›è¡Œäº†å•ç‹¬çš„æµ‹è¯•ï¼Œå½“ç„¶å•ç‹¬æµ‹è¯•çš„æ—¶å€™éƒ½æ˜¯ä¸€åˆ‡æ­£å¸¸ï¼Œæ‰€ä»¥åœºæ™¯å¤§æ¦‚æ˜¯è¿™æ ·çš„â€¦

![img](./image/ant/2.png)

è™½ç„¶å¾ˆå¿«å°±æ€€ç–‘åˆ°äº† SDK å’Œ shim éƒ¨åˆ†ï¼Œä½†æ˜¯ä¹Ÿä¸æ¸…æ¥šé—®é¢˜åˆ°åº•å‡ºåœ¨å“ªé‡Œã€‚ç›´åˆ°åœ¨ library çš„æ—¥å¿—ä¸­å‘ç°äº†ä¸€æ¡åŸæœ¬åªåº”è¯¥åœ¨å¯åŠ¨çš„æ—¶å€™è¾“å‡ºçš„æ—¥å¿—å‡ºç°äº†å¤æ•°æ¬¡çš„æ—¶å€™æ‰æ„è¯†åˆ°ä¸å¯¹åŠ²ã€‚å‡ºäºä¸€äº›åŸå› ï¼Œshim å’Œ library ä¸­éƒ½å­˜åœ¨æœ‰ TLS [2]ï¼ˆthread local storageï¼Œçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰ç»“æ„ï¼Œåœ¨ Rust std ä¸­å°±æä¾›äº†ä¸€ç§å®ç° [3]ã€‚å®ƒä¼šåœ¨æ¯ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡ä½¿ç”¨è¿™ä¸ªç»“æ„çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹‹ååŒä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šä¸€ç›´è®¿é—®åˆ°è¿™ä¸ªç»“æ„ï¼Œè€Œä¸åŒçš„çº¿ç¨‹ä¹‹é—´è®¿é—®åˆ°çš„æ˜¯ä¸åŒçš„ç»“æ„ã€‚è€Œé‚£æ¡é‡å¤å‡ºç°çš„æ—¥å¿—å°±æ˜¯ä¸€ä¸ª TLS ç»“æ„åœ¨åˆå§‹åŒ–æ—¶è¾“å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ TLS ä¸ç¬¦åˆé¢„æœŸåœ°è¢«é‡å¤åˆå§‹åŒ–äº†ã€‚

å…ˆçœ‹ä¸‹ Go åœ¨è¿›è¡Œ cgo è°ƒç”¨çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼ŒGo ä¸­æ¯ä¸ªçº¿ç¨‹ä¸ç³»ç»Ÿçº¿ç¨‹ä¸æ˜¯ä¸€ä¸€å¯¹åº”ï¼Œåœ¨è¿›è¡Œé Go çš„è°ƒç”¨æ—¶ï¼Œä¼šæŠŠå½“å‰ goroutine æ”¾åœ¨ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ä¸Šï¼Œä½¿ç”¨è¿™ä¸ªç³»ç»Ÿçº¿ç¨‹åå®Œæˆåç»­çš„è°ƒç”¨æµç¨‹ã€‚æ‰€ä»¥å¦‚æœä¸åšç‰¹æ®Šå¤„ç†çš„è¯å¯¹äº shim æ¥è¯´æ¯æ¬¡è¯·æ±‚éƒ½æœ‰å¯èƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸Šï¼Œè€Œä½¿å¾—ä¹‹å‰ä¿å­˜åœ¨ TLS ä¸­çš„çŠ¶æ€å¤±æ•ˆã€‚å¹¶ä¸”æ›´åŠ ä¸¥é‡çš„æ˜¯ï¼Œshim çš„ TLS ä¸­åŒ…æ‹¬äº†ä¸€äº› library çš„çº¿ç¨‹å¥æŸ„ï¼Œå¯¼è‡´ library çš„éƒ¨åˆ†çŠ¶æ€ä¹Ÿå‡ºç°äº†æ··ä¹±ï¼Œæœ€ç»ˆæ•´ä¸ªè¿›ç¨‹çš„è¡Œä¸ºéƒ½å˜å¾—å¾ˆå¥‡æ€ªã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ shim å’Œ library çš„çº¿ç¨‹å›ºå®šä½ï¼Œshim æ¥åˆ°è¯·æ±‚åé€šè¿‡çº¿ç¨‹ä¿¡æ¯ä¼ é€’çš„æ–¹å¼ä¸ library äº¤äº’ï¼ŒåŒ…æ‹¬å‘é€è¯·æ±‚ä¸æ¥æ”¶ç»“æœã€‚ä»£ç å¦‚ä¸‹

```rust
struct Handle {
    runtime: Runtime // this was TLS
}

impl Handle {
    fn new() -> Self{
        let worker_thread = std::thread::spawn(|| {}); // main thread, channels inside
        let runtime = Runtime::new(); // cb threads
        Self { runtime }
    }
}
```

åŒæ—¶æ¥éƒ½æ¥äº†ï¼Œä¹Ÿé¡ºä¾¿å°† library å¼‚æ­¥çš„æ¥å£æš´éœ²åˆ°äº†ä¸Šå±‚ï¼Œç”±åŸæ¥ä¸€æ¬¡ cgo å®Œæˆæ•´ä¸ªè¯·æ±‚çš„æ–¹å¼å˜æˆäº†ä¸€æ¬¡ cgo æäº¤è¯·æ±‚ï¼Œç»“æœé€šè¿‡åç»­å¦ä¸€æ¬¡ C->Go è°ƒç”¨å¼‚æ­¥åœ°è¿”å›ï¼Œä¹Ÿèƒ½å¤Ÿé˜²æ­¢å¤§è¯·æ±‚æŠŠ Go runtime spawn å‡ºæ¥çš„ cgo çº¿ç¨‹é˜»å¡å¤ªé•¿æ—¶é—´ã€‚ç°åœ¨çš„äº¤äº’æµç¨‹ç±»ä¼¼ä¸‹å›¾ï¼š

![img](./image/ant/3.png)

ä¸è¿‡è¿™åªæ˜¯å¾ˆåŸºç¡€çš„æ–¹æ¡ˆï¼Œâ€œå˜ç”µå™¨â€ cgo çš„åŸç†å¾ˆç®€å•ï¼Œä½†ä¹Ÿå­˜åœ¨è®¸å¤šä¼˜åŒ–ç©ºé—´ï¼Œèƒ½å¤Ÿåœ¨è§£å†³é—®é¢˜çš„åŒæ—¶é™ä½æŸè€— [5, 6, 7]ã€‚

## å†…å­˜

é™¤æ­¤ä¹‹å¤–ï¼Œä¸ºäº†é€šè¿‡ C çš„æ¥å£æ¥ä¼ é€’æ•°æ®ï¼Œéœ€è¦å¯¹æ•°æ®ç»“æ„è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸»è¦åœ¨ shim å’Œ SDK è¿›è¡Œã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠæ‰€æœ‰éœ€è¦ä¼ é€’çš„ç±»å‹éƒ½èƒ½å¤Ÿç”¨ C è¡¨ç¤ºå‡ºæ¥ï¼Œåœ¨è¿™é‡Œ [13] æä¾›äº†ä¸€äº›ä¾‹å­ï¼Œä¸‹é¢ä¹Ÿæœ‰æˆ‘ä»¬çš„ä¸€æ®µç¤ºä¾‹ï¼š

```rust
#[repr(C)]
pub struct Bytes {
    ptr: *mut libc::c_void,
    len: libc::size_t,
}

crate fn make_bytes(mut bytes: Vec<u8>) -> Self {
    bytes.shrink_to_fit();
    let (ptr, len, cap) = bytes.into_raw_parts();
    debug_assert_eq!(len, cap);

    Bytes {
        ptr: unsafe { mem::transmute::<*mut u8, *mut libc::c_void>(ptr) },
        len,
    }
}
```

Go ä¸ Rust åœ¨è¿œç¦» FFI è¾¹ç•Œçš„åœ°æ–¹ï¼ˆä¸€èˆ¬æ¥è¯´ï¼‰éƒ½èƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†å†…å­˜é—®é¢˜ï¼Œè¿™äº›éæ³•çš„æŒ‡é’ˆå’Œåœ°å€åŸºæœ¬ä¸Šéƒ½æ˜¯å¦ä¸€æ–¹ä¸¢è¿‡æ¥çš„ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä¸ºäº†å‡å°‘å·¥ä½œé‡æˆ‘ä»¬å·²ç»é€šè¿‡ä½¿ç”¨å¤§é‡çš„æ‹·è´å‡å°‘äº†è®¸å¤šä½¿ç”¨è£¸æŒ‡é’ˆçš„åœ°æ–¹ï¼Œå‰©ä¸‹çš„ä¸»è¦é›†ä¸­åœ¨ä¸¤å¤„ï¼Œå³æ¥æ”¶å¯¹æ–¹ä¼ é€’è¿‡æ¥çš„æ•°æ®ä»¥åŠé€šçŸ¥å¯¹æ–¹å›æ”¶è¿™ä¸€å—æ•°æ®çš„å†…å­˜ã€‚é™¤å¼€éµå®ˆè€ç”Ÿå¸¸è°ˆçš„â€œ**è°åˆ†é…è°é‡Šæ”¾**â€åŸåˆ™å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¦èƒ½å¤Ÿå¯¹å‡ºç°çš„é—®é¢˜è¿›è¡Œå®šä½ã€‚

æœ€å…ˆçš„å…¥æ‰‹ç‚¹å°±æ˜¯å‘ç”Ÿé”™è¯¯æ—¶æ‰€æ‰“å‡ºæ¥çš„å †æ ˆï¼ŒæŒ‰ç…§ç»éªŒè·Ÿç€ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯åçš„ç¬¬ä¸€æ¡ Go routine backtrace é€šå¸¸æ˜¯å‘ç”Ÿé—®é¢˜çš„åœ°æ–¹ã€‚å¯ä»¥å…ˆé¡ºç€è°ƒç”¨æ ˆæ£€æŸ¥ä¸€ä¸‹ä»£ç ä¸­æ˜¯å¦æœ‰ä¸æ­£ç¡®çš„æŒ‡é’ˆä½¿ç”¨ã€‚ä¸è¿‡è¿™ä¸ªå †æ ˆä¸­åªä¼šå­˜åœ¨ Go è¿™ä¸€éƒ¨åˆ†çš„ä¿¡æ¯ã€‚å½“é—®é¢˜å‡ºç°åœ¨ Go ä¹‹å¤–çš„æ—¶å€™æˆ‘ä»¬åªèƒ½å¤ŸçŸ¥é“æ˜¯å“ªä¸€ä¸ª cgo å‡½æ•°å€¼å¾—æ€€ç–‘ã€‚è¿™ä¸€éƒ¨åˆ†å°±å’Œæ™®é€šçš„å†…å­˜é—®é¢˜æ’æŸ¥å·®ä¸å¤šï¼Œæˆ‘ä»¬å‡ ä¸ªå¸¸ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š

#### æ‰“å°æ—¥å¿—

å¦‚æœé—®é¢˜æ¯”è¾ƒå¥½å¤ç°çš„è¯ï¼Œå¯ä»¥åœ¨è·¯å¾„ä¸Šå¤šå¢åŠ ä¸€äº›æ—¥å¿—è¾“å‡ºï¼ŒæŠŠå€¼å¾—æ€€ç–‘çš„æŒ‡é’ˆåœ°å€ä»¥åŠå®ƒä»¬è§£å¼•ç”¨ä¹‹åçš„å†…å®¹æ‰“å°å‡ºæ¥ï¼Œæœ‰æ—¶èƒ½å¤Ÿè§‚å¯Ÿåˆ°ä¸€ä¸ªæŒ‡é’ˆæ˜¯å¦‚ä½•ä¸€æ­¥æ­¥èµ°å‘éæ³•çš„ã€‚æ³¨æ„è§£å¼•ç”¨æ—¶æœ€å¥½æ”¾åˆ°å¦ä¸€è¡Œæ—¥å¿—ä¸­ï¼Œæ¯ä¸€ä¸ªè§£å¼•ç”¨æ“ä½œéƒ½æ˜¯åœ¨éæ³•è¾¹ç¼˜è¯•æ¢ï¼Œå¦‚æœè¿™ä¸ªæŒ‡é’ˆåœ¨è§£å¼•ç”¨çš„æ—¶å€™å‡ºé”™å¯èƒ½ä¼šå¸¦ç€å…¶ä»–æœ‰ç”¨çš„æ—¥å¿—è¾“å‡ºä¸€èµ·æ¶ˆå¤±ã€‚

#### å€ŸåŠ©å·¥å…·

ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›å·¥å…·æ¥ç›‘æµ‹å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚å„ç§ sanitizer [8]ï¼Œvalgrind [9] ç­‰ï¼Œæœ‰çš„æ—¶å€™ä¸æ˜¯æ‰€æœ‰çš„å†…å­˜é—®é¢˜éƒ½ä¼šå¯¼è‡´ç¨‹åºæŒ‚æ‰ï¼Œä¸€äº›éæ³•çš„å†…å­˜æ“ä½œæœ‰å¯èƒ½è¢«å¿½ç•¥ï¼Œæ¯”å¦‚æ•°ç»„ç¨å¾®è¶Šç•Œä¸€ç‚¹ç‚¹ï¼Œä¸å°å¿ƒ free å¤šæ¬¡æˆ–å¿˜è®° free ç­‰ã€‚è¿™äº›å·¥å…·èƒ½å¤Ÿå¸®åŠ©åŠæ—¶çš„å‘ç°è¿™äº›é—®é¢˜ã€‚ä¸è¿‡å®ƒä»¬éƒ½æˆ–å¤šæˆ–å°‘ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å½±å“ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯æ‰€æœ‰æƒ…å†µéƒ½é€‚ç”¨ã€‚

```bash
# valgrind
$ cargo build
$ valgrind --leak-check=full --show-leak-kinds=all --tool=memcheck $(BIN)

# address sanitizer
$ export RUSTFLAGS=-Zsanitizer=address RUSTDOCFLAGS=-Zsanitizer=address
$ cargo run -Zbuild-std --target x86_64-unknown-linux-gnu
```

#### ç‰¹æ®Šå€¼

æœ‰äº›ç¯å¢ƒä¼šåœ¨å†…å­˜æ“ä½œå‰åæŠŠé‚£ä¸€å—å†…å­˜è®¾ç½®ä¸Šç‰¹æ®Šå€¼æ¥è¡¨ç¤ºè¿™å—å†…å­˜çš„çŠ¶æ€ï¼Œä½¿å®ƒèƒ½æ–¹ä¾¿åœ°è¢«è§‚å¯Ÿåˆ°ã€‚å¦‚ jemalloc çš„ `--enable-fill` å‚æ•° [10] æˆ– MariaDB çš„ `TRASH_ALLOC()` [11] å®ã€‚

#### ç¼©å°èŒƒå›´

åˆ†ä¸ºä¸¤ä¸ªæ–¹é¢çš„ç¼©å°ã€‚å¦‚æœæ¡ä»¶å…è®¸çš„è¯ä¹Ÿå¯ä»¥é€šè¿‡æ³¨é‡Šæ‰ä¸€äº›ä»£ç æ¥ç¼©å°æ’æŸ¥èŒƒå›´ï¼Œæ¯”å¦‚å…ˆä¸è¿›è¡Œ free æ“ä½œæˆ–è€…æš‚åœéƒ¨åˆ†è·¯å¾„è¿›è¡Œè§‚å¯Ÿï¼›ä»¥åŠç¼©çŸ­è°ƒç”¨è·¯å¾„ï¼Œå¯¹å„ä¸ªç»„ä»¶è¿›è¡Œ mock æµ‹è¯•ã€‚

è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å°åœ°æ–¹ï¼Œæ¯”å¦‚è§‚å¯ŸæŒ‡é’ˆæ˜¯å¦å¯¹é½ï¼Œå‡ºé”™çš„æŒ‡é’ˆä¸å‘¨å›´æŒ‡é’ˆçš„èŒƒå›´ç­‰ã€‚æ¯”å¦‚è¿™é‡Œ Go ä¸ Rust è¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œèƒ½å¤Ÿè§‚å¯Ÿå‡º Go å‡ºæ¥çš„æŒ‡é’ˆå’Œ Rust å‡ºæ¥çš„æŒ‡é’ˆåœ¨ä¸¤ä¸ªåœ°å€æ®µä¸Šï¼ŒæŒ‡é’ˆçš„å€¼æœ‰æ—¶å€™ä¹Ÿèƒ½å¤Ÿè¯´æ˜ä¸€äº›ä¿¡æ¯ï¼ˆä¸æ˜¯æ•…æ„è®²è¿™ä¹ˆç„ä¹çš„â€¦ï¼‰ã€‚ä¸è¿‡è¯´å½’è¯´ï¼Œåœ¨å®é™…è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„å†…å­˜é—®é¢˜è¡¨é¢ä¸Šåƒç¯‡ä¸€å¾‹ï¼ŒèƒŒåœ°é‡Œå„æœ‰åƒç§‹ã€‚å½“ç¨‹åºæœ‰ä¸€ä¸ªå†…å­˜é—®é¢˜æ—¶å¯èƒ½ä¼šå¸¦æ¥å„ç§åƒå¥‡ç™¾æ€ªçš„è¡¨ç°ï¼Œå› æ­¤ä¹Ÿéœ€è¦èƒ½å¤Ÿå¯¹ä¸åŒçš„é—®é¢˜è¿›è¡Œåˆ†ç±»å¹¶æ¡ˆã€‚åœ¨æœ‰å„ç§æ–¹æ³•æ‰‹å†Œçš„åŒæ—¶ä¹Ÿé¿å…å½¢æˆå›ºå®šæµç¨‹ï¼Œè€Œæ˜¯èƒ½å¤Ÿæ ¹æ®æ–°å¾—åˆ°çš„ä¿¡æ¯åŠæ—¶è°ƒæ•´æ‰‹æ®µã€‚æ¯•ç«Ÿä¸€èˆ¬æ¥è¯´å…¨ç„¶æ— è®¡å¯æ–½çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œè€Œç»å¸¸æ˜¯æœ‰è®¸å¤šæ‰‹æ®µä½†ä¸çŸ¥é“å“ªä¸€ä¸ªæ‰èƒ½å¾—åˆ°ä¿¡æ¯ã€‚æ¯ä¸ªæŠ€èƒ½éƒ½ä¼šæœ‰æ–½æ³•æ—¶é—´æ¶ˆè€—ï¼Œä¸‡ä¸€è¢« invalid pointer çº ç¼ å¤ªä¹…å¯¼è‡´åšæ¢¦éƒ½æ˜¯ panic å°±å¾ˆç—›è‹¦äº† TATã€‚


åœ¨åˆ¶ä½œ shimï¼Œbinding å’Œå®ƒä»¬çš„ c demo çš„æ—¶å€™é€šè¿‡ä¸€äº› C é‡æ–°ä½“éªŒäº†ä¸€ä¸‹æ–‡æ˜çš„è¿›æ­¥ï¼Œä½†æ˜¯å›è¿‡å¤´æƒ³æƒ³æ˜¯ä¸æ˜¯æœ‰æ›´å…ˆè¿›çš„æ–¹æ³•æ¥é¿å… unsafe ä¸€æŠŠæ¢­çš„ FFI å‘¢ï¼Œè¿™æ˜¯æˆ‘ä»¬åé¢éœ€è¦ç»§ç»­æ€è€ƒçš„é—®é¢˜ã€‚

## ä¿¡å·

è¿™æ˜¯ä¸€ä¸ªèŠ±äº†æ¯”è¾ƒä¹…æ—¶é—´çš„é—®é¢˜ï¼Œç”±ä¸€æ¬¡ SIGSEGV å¼€å§‹ï¼Œå…ˆå‰§é€ä¸€ä¸‹è¿™ä¸ªæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå†…å­˜é—®é¢˜ã€‚

```plain
fatal error: unexpected signal during runtime execution
[signal SIGSEGV: segmentation violation code=0x2 addr=0x18589091b1 pc=0x7f9205f814ba]

runtime stack:
runtime.throw({0xace954, 0xefc4e055})
        /home/go/src/runtime/panic.go:1198 +0x71 fp=0x7f91dce8afe8 sp=0x7f91dce8afb8 pc=0x448451
runtime.sigpanic()
        /home/go/src/runtime/signal_unix.go:719 +0x396 fp=0x7f91dce8b038 sp=0x7f91dce8afe8 pc=0x45fdf6
```

è¿™é‡Œçš„å¤ç°æ¯”è¾ƒèŠ±æ—¶é—´ï¼ŒåŸå§‹åœºæ™¯ä¸€èˆ¬éœ€è¦åŠå¤©åˆ°ä¸€å¤©æ‰èƒ½å‡ºç°ï¼ŒåŒæ—¶ä¹Ÿæœ‰å…¶ä»–æœªè§£å†³çš„é—®é¢˜æ··æ‚åœ¨ä¸€èµ·ï¼Œå¹¶ä¸”å­˜åœ¨è®¸å¤šä¸åŒçš„ç³»ç»Ÿç¯å¢ƒå’Œæµé‡ï¼Œå„æ–¹é¢æé«˜äº†æ’æŸ¥çš„éš¾åº¦ã€‚



åœ¨èŠ±äº†ä¸€äº›æ—¶é—´æŠŠå…¶ä»–çš„å› ç´ éƒ½æ’é™¤æ‰ä¹‹åï¼Œæˆ‘ä»¬æŠŠç²¾åŠ›é›†ä¸­åˆ°äº† SIGSEGV äº§ç”Ÿçš„ core dump æ–‡ä»¶ä¸Šã€‚ä½†æ˜¯é€šè¿‡ gdb æŸ¥çœ‹ core æ—¶ï¼Œå®ƒä»¬éƒ½åŸºæœ¬ä¸Šæ˜¯è¿™æ ·çš„

```plain
Thread  (Thread 0x7f7c45fef700 (LWP 47715)):
#0  0x0000000000895b93 in runtime.futex ()
#1  0x0000000000860a20 in runtime.futexsleep ()
#2  0x0000000001dea010 in runtime.sched ()
#3  0x0000000000000080 in ?? ()
#4  0x00007f7c45feccb0 in ?? ()
#5  0x0000000000000000 in ?? ()
Thread  (Thread 0x7f7c457ee700 (LWP 47716)):
#0  0x0000000000895b93 in runtime.futex ()
#1  0x00000000008609ab in runtime.futexsleep ()
#2  0x000000c00011e840 in ?? ()
#3  0x0000000000000080 in ?? ()
#4  0x0000000000000000 in ?? ()
Thread  (Thread 0x7f7c4468c700 (LWP 52927)):
#0  0x00007f7c49301489 in syscall () from /lib64/libc.so.6
#1  0x00007f7c49834da9 in futex_wait (self=0x7f7c4468a640, ts=...) at parking_lot_core-0.8.5/src/thread_parker/linux.rs:112
```

é—®å·çš„å¾ˆå¥½çŒœæ˜¯ Go çš„ m:n çº¿ç¨‹æ¥çš„ï¼Œä½†æ˜¯å…¶ä»–é Go çš„çº¿ç¨‹å´éƒ½åœåœ¨ syscall ä¸Šã€‚å®Œå…¨ä¸çŸ¥é“åˆ°åº•è¯¥ blame è°ï¼Œä¸ºäº†æŸ¥çœ‹ä¸‹ Go é‡Œé¢å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨ delve [12] æ¥æŸ¥çœ‹ Go çš„å †æ ˆï¼Œç”¨æ³•å’Œ gdb ç±»ä¼¼ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰äº›ç—›è‹¦çš„è¿‡ç¨‹ï¼Œdump å‡ºäº†å‡ åƒä¸ª goroutine çš„ backtraceï¼ŒèŠ±äº†äº›æ—¶é—´ç®€å•å¯¹æ ˆé¡¶åˆ†æäº†ä¸€ä¸‹ä¹‹åï¼Œä¹Ÿå‘ç°åŸºæœ¬éƒ½æ˜¯ä¸šåŠ¡ goroutineï¼Œæ²¡æœ‰ä»€ä¹ˆå€¼å¾—æ€€ç–‘çš„ã€‚

```plain
(dlv)   Goroutine 1 - User: main.go:207 main.main (0xfa6f0e) [chan receive (nil chan) 451190h16m34.324364485s]
  Goroutine 2 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [force gc (idle) 451190h16m34.619109482s]
  Goroutine 3 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [GC sweep wait]
  Goroutine 4 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [GC scavenge wait]
  Goroutine 5 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [finalizer wait 451190h14m6.860088484s]
* Goroutine 17 - User: /root/go/src/runtime/sys_linux_amd64.s:165 runtime.raise (0x82acc1) (thread 71636) [GC assist marking]
  Goroutine 47 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [select 451190h16m34.324667846s]
  Goroutine 48 - User: /root/go/src/runtime/sigqueue.go:169 os/signal.signal_recv (0x825998) (thread 67111)
```

å”¯ä¸€çš„ä¿¡æ¯å°±æ˜¯çœ‹åˆ°äº† SIGSEGV æ˜¯ä»å“ªé‡Œå‡ºæ¥çš„ï¼ˆGoroutine 17ï¼‰

```plain
runtime.throw({0xace954, 0xefc4e055})
        /home/go/src/runtime/panic.go:1198 +0x71 fp=0x7f91dce8afe8 sp=0x7f91dce8afb8 pc=0x448451
runtime.sigpanic()
        /home/go/src/runtime/signal_unix.go:719 +0x396 fp=0x7f91dce8b038 sp=0x7f91dce8afe8 pc=0x45fdf6
```

çœ‹ç€æœ‰ç‚¹çœ¼ç†Ÿï¼Œå°±æ˜¯ç»å¸¸åœ¨é”™è¯¯ä¿¡æ¯é‡Œé¢å‡ºç°çš„ç¬¬ä¸€è¡Œ stackã€‚è¿™ä¸ª goroutine åªæœ‰ä¸Šé¢ä¸¤å±‚ï¼Œåªèƒ½è¯´è¿™ä¸ªä¿¡æ¯è™½ç„¶æœ‰ç”¨ï¼Œä½†ä¹ŸåŸºæœ¬æ²¡ç”¨ : (

åˆç»è¿‡äº†ä¸€äº›æ—¶é—´çš„æŒ£æ‰ï¼Œæœ€åæ€€ç–‘ä¸Šé¢çœ‹åˆ°çš„ core dump å¹¶ä¸æ˜¯å®é™…ä¸Šçš„ç¬¬ä¸€æ‰‹å †æ ˆã€‚é€šè¿‡æŠŠè¿›ç¨‹æŒ‚åœ¨ gdb é‡Œé¢è¿è¡Œï¼Œç»ˆäºèƒ½å¤Ÿæ‹¿åˆ°éæ³•æ“ä½œå®é™…ä¸Šå‡ºç°çš„ä½ç½®ï¼Œgdb åœ¨ä¿¡å·ç¬¬ä¸€æ¬¡æŠ›å‡ºçš„æ—¶å€™å…ˆäº Go runtime æ•è·åˆ°å®ƒã€‚ç°åœ¨å›çœ‹èµ·æ¥æƒ³è¯´ï¼šå¦‚æœæ—©çŸ¥é“ï¼Œå †æ ˆä¿¡å·ä¼šè¢« Go runtime è½¬æ‰‹â€¦

![img](./image/ant/4.png)

åœ¨èƒ½å¤Ÿçœ‹åˆ°ç¬¬ä¸€æ¡ˆå‘ç°åœºä¹‹åï¼Œåç»­çš„æµç¨‹å°±æ¯”è¾ƒæ™®é€šäº†ï¼Œä¹Ÿæ˜¯åœ¨å½“å¤©ä¸‹åˆå°±å®Œæˆäº†ä¿®å¤è§£è„±äº†å‡ºæ¥ã€‚

## æœ€å

æ¯æ¬¡è°ƒ bug ä¸€èˆ¬æœ€èŠ±æ—¶é—´çš„å°±æ˜¯å®šä½ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ²¡æ€ä¹ˆæçš„äº‹å‰å‡†å¤‡ï¼Œå¦‚é¿å… bug äº§ç”Ÿï¼Œæå‰å‡†å¤‡å¥½è¶æ‰‹çš„å·¥å…·ï¼Œæœ‰å„ç§å¤ç°æ–¹æ³•ç­‰ï¼›å’Œå‡ºç° bug ä¹‹åæ ¹æ®ä¿¡æ¯æ¥ä¸€æ­¥æ­¥æ’æŸ¥çš„æ‰‹æ®µéƒ½å¾ˆé‡è¦ã€‚æœ€åç¥å„ä½å’Œè‡ªå·±æ—¶å¸¸ä¸€å†™å°±å¯¹ä¸€è·‘å°±è¿‡ğŸ¤¤ã€‚

## å‚è€ƒ

- [1: https://doc.rust-lang.org/reference/linkage.html](https://doc.rust-lang.org/reference/linkage.html)
- [2: https://en.wikipedia.org/wiki/Thread-local_storage](https://en.wikipedia.org/wiki/Thread-local_storage)
- [3: https://doc.rust-lang.org/std/macro.thread_local.html](https://doc.rust-lang.org/std/macro.thread_local.html)
- [5: https://mp.weixin.qq.com/s/PdeLX4loFaXr4E74hsrHCw](https://mp.weixin.qq.com/s/PdeLX4loFaXr4E74hsrHCw)
- [6: https://about.sourcegraph.com/go/gophercon-2018-adventures-in-cgo-performance/](https://about.sourcegraph.com/go/gophercon-2018-adventures-in-cgo-performance/)
- [7: https://www.cockroachlabs.com/blog/the-cost-and-complexity-of-cgo/](https://www.cockroachlabs.com/blog/the-cost-and-complexity-of-cgo/)
- [8: https://doc.rust-lang.org/beta/unstable-book/compiler-flags/sanitizer.html](https://doc.rust-lang.org/beta/unstable-book/compiler-flags/sanitizer.html)
- [9: https://valgrind.org/](https://valgrind.org/)
- [10: https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Find-a-memory-corruption-bug](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Find-a-memory-corruption-bug)
- [11: https://github.com/MariaDB/server/blob/c9fcea14e9e1f34a97451706eac51276c85bbea7/include/my_valgrind.h?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L97-L100](https://github.com/MariaDB/server/blob/c9fcea14e9e1f34a97451706eac51276c85bbea7/include/my_valgrind.h?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L97-L100)
- [12: https://github.com/go-delve/delve](https://github.com/go-delve/delve)
- [13: http://jakegoulding.com/rust-ffi-omnibus/](http://jakegoulding.com/rust-ffi-omnibus/)